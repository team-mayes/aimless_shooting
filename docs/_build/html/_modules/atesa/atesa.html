

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>atesa.atesa &mdash; atesa  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> atesa
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">For Users:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">Under the Hood:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Function and Class Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">atesa</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>atesa.atesa</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for atesa.atesa</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="c1"># Core Aimless Transition Ensemble Sampling and Analysis (ATESA) code. Tucker Burgin, 2018</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pytraj</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="k">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
<span class="c1">#from atesa import rc_eval                                              # this one I think might not work at all</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">rc_eval</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.rc_eval&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">__package__</span><span class="p">)</span>  <span class="c1"># this one works with tests</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="n">rc_eval</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;rc_eval&#39;</span><span class="p">)</span>                        <span class="c1"># this one works to run code, but breaks tests</span>


<span class="c1"># Define the &quot;thread&quot; object that constitutes one string of shooting moves in our search through phase space. Each</span>
<span class="c1"># thread is an independent series of simulations with its own acceptance ratio, and may or may not have a unique</span>
<span class="c1"># starting structure.</span>
<div class="viewcode-block" id="Thread"><a class="viewcode-back" href="../../autosummary/atesa.Thread.html#atesa.Thread">[docs]</a><span class="k">class</span> <span class="nc">Thread</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>           <span class="c1"># add (object) explicitly to force compatibility of restart pickle file with Python 2</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object representing a series of simulations and containing the relevant information to define its current state.</span>

<span class="sd">    Threads represent the level on which ATESA is parallelized. This flexible object is used for aimless shooting,</span>
<span class="sd">    equilibrium path sampling, and committor analysis simulations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Thread.__init__"><a class="viewcode-back" href="../../autosummary/atesa.Thread.html#atesa.Thread.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>      <span class="c1"># first part of name, universal to all files in the thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>          <span class="c1"># full name, identical to basename unless otherwise specified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># appended to basename after an underscore to build name. Should be str(an integer)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># current batch system jobid associated with the thread init step or forward trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobid2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># another jobid slot, for the backward trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>          <span class="c1"># thread job type; init to get initial trajectories or prod to run forward and backward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>    <span class="c1"># name of previous thread to initialize shooting from</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>   <span class="c1"># suffix of the most recent shooting point that resulted in a valid transition path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>       <span class="c1"># flag indicating commitment direction for the fwd trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>       <span class="c1"># flag indicating commitment direction for the bwd trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># running total of completed shooting moves that were accepted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_moves</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># running total of completed shooting moves with any result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prmtop</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># name of parameter/topology file corresponding to this thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failcount</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c1"># number of unaccepted shooting moves in a row for this thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># string to indicate which termination criterion ended the thread, if applicable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># for each job in this thread&#39;s history, includes job name and result code: F = both went forward, B = both went backward, S = success, and X = one or both simulations failed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commitlist</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># for use in committor analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobidlist</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># for use in committor analysis</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>    <span class="c1"># number of beads to propagate forward in the next step</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps_bwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">-</span> <span class="mi">1</span>       <span class="c1"># number of beads to propagate backward in the next step</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps_fwd_la</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_fwd</span>                          <span class="c1"># value from the last accepted move</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_bwd</span>                          <span class="c1"># value from the last accepted move</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># lower boundary of RC window that this thread started in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># upper boundary of RC window that this thread started in</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>    <span class="c1"># allows Thread() to be called without requiring eps_settings to have been defined yet</span></div></div>


<span class="c1"># Then, define a series of functions to perform the basic tasks of creating batch files, interacting with the batch</span>
<span class="c1"># system, and interpreting/modifying coordinate and trajectory files.</span>
<div class="viewcode-block" id="handle_groupfile"><a class="viewcode-back" href="../../autosummary/atesa.handle_groupfile.html#atesa.handle_groupfile">[docs]</a><span class="k">def</span> <span class="nf">handle_groupfile</span><span class="p">(</span><span class="n">job_to_add</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update attributes of settings.groupfile_list and return name of the groupfile that should be written to next.</span>

<span class="sd">    Routine to handle groupfiles when necessary (i.e., when groupfile &gt; 0). Maintains a list object keeping track of</span>
<span class="sd">    existing groupfiles and their contents as well as their statuses and ages. This function is called in makebatch()</span>
<span class="sd">    to return the name of the groupfile that that function should be writing to, and subbatch() redirects here when</span>
<span class="sd">    groupfile &gt; 0. Finally, it is called at the end of every main_loop loop to update statuses as needed.</span>

<span class="sd">    job_to_add is an optional argument; if present, this function appends the name of the job given to the &lt;CONTENTS&gt;</span>
<span class="sd">    field for the groupfile that it returns. This puts the onus on the code that calls handle_groupfile() to actually</span>
<span class="sd">    put that job in that groupfile, of course!</span>

<span class="sd">    Process flow for this function:</span>
<span class="sd">      1. iterate through existing list of groupfiles as read from settings.groupfile_list</span>
<span class="sd">      2. update statuses as necessary</span>
<span class="sd">      3. submit any of them that have status &quot;construction&quot; and length == settings.groupfile, or</span>
<span class="sd">         age &gt; settings.groupfile_max_delay and length &gt;= 1 (where length means number of lines)</span>
<span class="sd">      4. if the list no longer contains any with status &quot;construction&quot;, make a new, blank one and return its name</span>
<span class="sd">      5. otherwise, return the name of the groupfile with status &quot;construction&quot;</span>

<span class="sd">    Format of each sublist of settings.groupfile_list: [&lt;NAME&gt;, &lt;STATUS&gt;, &lt;CONTENTS&gt;, &lt;TIME&gt;]</span>
<span class="sd">          &lt;NAME&gt; is the name of the groupfile</span>
<span class="sd">          &lt;STATUS&gt; is any of:</span>
<span class="sd">              &quot;construction&quot;, meaning this groupfile is the one to add new lines to (only one of these at a time),</span>
<span class="sd">              &quot;completed&quot;, meaning the groupfile was submitted and has since terminated,</span>
<span class="sd">              &quot;processed&quot;, meaning the groupfile has been fed through main_loop and followup jobs submitted, or</span>
<span class="sd">              a string of numbers indicating a jobid of a currently-running groupfile</span>

<span class="sd">          &lt;CONTENTS&gt; is a list of the jobs contained in the groupfile (their (thread.name + &#39;_&#39; + thread.type) values)</span>
<span class="sd">          &lt;TIME&gt; is the time in seconds when the groupfile was created</span>
<span class="sd">              if the current time - TIME &gt; settings.groupfile_max_delay, then the groupfile is submitted regardless of length</span>
<span class="sd">              (assuming it&#39;s at least of length 1)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    job_to_add : str</span>
<span class="sd">        Name of job to append to the current groupfile&#39;s settings.groupfile_list entry. Default = &#39;&#39; (don&#39;t add any jobs)</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Name of the groupfile to which new jobs should be appended.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">new_groupfile</span><span class="p">(</span><span class="n">job_to_add_local</span><span class="p">):</span>
        <span class="c1"># Specialized subroutine to build a new empty groupfile and add its information to the settings.groupfile_list</span>
        <span class="c1"># If a job_to_add is present, add it to the new settings.groupfile_list entry.</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile_list</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\_[0-9]*&#39;</span><span class="p">)</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">groupfile_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># this gets the suffix of the last groupfile</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;groupfile_&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                     <span class="c1"># make a new, empty groupfile</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">groupfile_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;groupfile_&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">,</span><span class="s1">&#39;construction&#39;</span><span class="p">,</span><span class="n">job_to_add_local</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()])</span>
        <span class="k">return</span> <span class="s1">&#39;groupfile_&#39;</span> <span class="o">+</span> <span class="n">suffix</span>

    <span class="k">def</span> <span class="nf">sub_groupfile</span><span class="p">(</span><span class="n">groupfile_name</span><span class="p">):</span>
        <span class="c1"># Specialized subroutine to submit a groupfile job as a batch job</span>
        <span class="c1"># Creates a batchfile from the template and submits, returning jobid</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">+</span> <span class="s1">&#39;_groupfile.tpl&#39;</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing groupfile batch file for &#39;</span> <span class="o">+</span> <span class="n">groupfile_name</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># This block necessary to submit jobs with one fewer than max groups when &quot;flag&quot; from outer scope is True</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">groupcount</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">this_ppn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span> <span class="o">-</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span><span class="o">/</span><span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span><span class="p">))</span>  <span class="c1"># remove cores proportional to removed simulations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groupcount</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span>
            <span class="n">this_ppn</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_nodes</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">this_ppn</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_walltime</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sander&#39;</span><span class="p">,</span>
                                 <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_mem</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">groupcount</span><span class="o">=</span><span class="n">groupcount</span><span class="p">,</span>
                                 <span class="n">groupfile</span><span class="o">=</span><span class="n">groupfile_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">groupfile_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">groupfile_name</span> <span class="o">+</span> <span class="s1">&#39;_groupfile.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="n">groupfile_name</span> <span class="o">+</span> <span class="s1">&#39;_groupfile.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>


    <span class="k">for</span> <span class="n">groupfile_data</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>                                            <span class="c1"># if groupfile was running when this function was last called</span>
            <span class="n">null</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>               <span class="c1"># cast to int only works if status is a jobid</span>
            <span class="c1"># Check queue to see if it&#39;s still running</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="s1">&#39;queue&#39;</span><span class="p">,</span><span class="n">settings</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>         <span class="c1"># all jobs in the groupfile have finished</span>
                <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;completed&#39;</span>         <span class="c1"># update job status</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;construction&#39;</span><span class="p">:</span>     <span class="c1"># groupfile is the one being built</span>
                <span class="c1"># First, check if this groupfile is due to be submitted based on settings.groupfile_max_delay</span>
                <span class="n">age</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>   <span class="c1"># age of groupfile entry</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">groupfile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
                <span class="c1"># flag helps us know to submit jobs a little early when there are only prod jobs in the itinerary and</span>
                <span class="c1"># no room for both halves of another prod job in the groupfile todo: won&#39;t work with committor analysis</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;init&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">((</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile_max_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="ow">or</span> <span class="n">flag</span><span class="p">):</span>
                    <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_groupfile</span><span class="p">(</span><span class="n">groupfile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    <span class="c1"># submit groupfile with call to sub_groupfile()</span>
                    <span class="k">return</span> <span class="n">new_groupfile</span><span class="p">(</span><span class="n">job_to_add</span><span class="p">)</span>    <span class="c1"># make a new groupfile to return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job_to_add</span><span class="p">:</span>                      <span class="c1"># add the job_to_add to the contents field, if applicable</span>
                        <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">job_to_add</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                    <span class="k">return</span> <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            <span class="c1"># this is the current groupfile and it&#39;s not full, so return it</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile_list</span><span class="p">:</span>                          <span class="c1"># this is the first call to this function, so no groupfiles exist yet</span>
        <span class="k">return</span> <span class="n">new_groupfile</span><span class="p">(</span><span class="n">job_to_add</span><span class="p">)</span>            <span class="c1"># make a new groupfile to return</span></div>


<div class="viewcode-block" id="interact"><a class="viewcode-back" href="../../autosummary/atesa.interact.html#atesa.interact">[docs]</a><span class="k">def</span> <span class="nf">interact</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle submitting of jobs to the batch system or looking up of currently queued and running jobs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    type : str</span>
<span class="sd">        Two valid options:</span>
<span class="sd">        - &quot;queue&quot;, to get currently queued and running jobs, or</span>
<span class="sd">        - anything else, to submit the batch file given by type to the batch system</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        output from batch system depending on the input:</span>
<span class="sd">        - &quot;queue&quot;, returns raw output</span>
<span class="sd">        - anything else, returns the jobid number of the newly submitted batch job (as a string)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUGMODE</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;queue&#39;</span><span class="p">:</span>
            <span class="c1"># Just return an empty qstat string</span>
            <span class="k">return</span> <span class="s1">&#39;JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: interact() does not support DEBUGMODE with (not type == </span><span class="se">\&#39;</span><span class="s1">queue</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="n">user_alias</span> <span class="o">=</span> <span class="s1">&#39;$USER&#39;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        <span class="c1"># line just here to suppress &quot;variable may be called before being defined&quot; error in my IDE</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;queue&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;pbs&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;qselect -u &#39;</span> <span class="o">+</span> <span class="n">user_alias</span> <span class="o">+</span> <span class="s1">&#39; -s QR&#39;</span>
        <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;squeue -u &#39;</span> <span class="o">+</span> <span class="n">user_alias</span>
    <span class="k">else</span><span class="p">:</span>               <span class="c1"># submitting the batch file given by &quot;type&quot;</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;pbs&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;qsub &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;sbatch &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                               <span class="n">close_fds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># Some PBS-specific error handling to help handle common issues by simply resubmitting as necessary.</span>
    <span class="k">while</span> <span class="s1">&#39;Pbs Server is currently too busy to service this request. Please retry this request.&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                   <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                                   <span class="n">close_fds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;Bad UID for job execution MSG=user does not exist in server password file&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="ow">or</span>\
       <span class="s1">&#39;This stream has already been closed. End of File.&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: attempted to submit a job, but got error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="o">+</span> <span class="s1">&#39;Retrying in one minute...&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                   <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                                   <span class="n">close_fds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;queue&#39;</span><span class="p">:</span>     <span class="c1"># return raw output</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>                   <span class="c1"># return jobid of submitted job, or exit with error message if submission failed</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Batch system says: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: unable to submit a batch job: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. Got message: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span></div>


<div class="viewcode-block" id="makebatch"><a class="viewcode-back" href="../../autosummary/atesa.makebatch.html#atesa.makebatch">[docs]</a><span class="k">def</span> <span class="nf">makebatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make the appropriate batch file for the given thread; or, append the appropriate line to the current groupfile.</span>

<span class="sd">    Has two mutually exclusive branches:</span>
<span class="sd">    - When groupfile == 0, makes the batch file appropriate for thread.type, using other thread attributes as necessary,</span>
<span class="sd">      by filling a Jinja2 template from the &quot;templates&quot; directory</span>

<span class="sd">    - When groupfile &gt; 0, appends a new line to the groupfile indicated by handle_groupfile() appropriate for</span>
<span class="sd">      thread.type.</span>

<span class="sd">    If thread.type == &#39;committor_analysis&#39;, then the additional parameter n_shots is required to identify the number of</span>
<span class="sd">    committor analysis batch jobs to prepare.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thread : Thread</span>
<span class="sd">        The Thread object for which to prepare the requisite file(s).</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_file : str</span>
<span class="sd">        Name of the newly written file. If more than one file was written, this is only the most recent one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">+</span> <span class="s1">&#39;.tpl&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;input_files&#39;</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not locate input_files folder: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;input_files</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;See documentation for the </span><span class="se">\&#39;</span><span class="s1">home_folder</span><span class="se">\&#39;</span><span class="s1"> option.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
        <span class="n">prod_fwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/eps&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span>
        <span class="n">prod_bwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/eps&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prod_fwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/prod.in&#39;</span>
        <span class="n">prod_bwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/prod.in&#39;</span>

    <span class="c1"># Append a new line to the current groupfile (this is spiritually similar to building a batch file for jobs that are</span>
    <span class="c1"># submitted individually; the actual batch file to submit the group file is built by handle_groupfile() when ready)</span>
    <span class="c1"># This implementation is ugly because groupfile support was added later in development. If I ever get the chance to</span>
    <span class="c1"># go back through and rewrite this code, this is an opportunity for polish!</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">current_groupfile</span> <span class="o">=</span> <span class="n">handle_groupfile</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/init.in&#39;</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init.out&#39;</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span>
            <span class="n">inpcrd</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init.nc&#39;</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-i &#39;</span> <span class="o">+</span> <span class="n">inp</span> <span class="o">+</span> <span class="s1">&#39; -o &#39;</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> <span class="o">+</span> <span class="n">top</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span> <span class="n">inpcrd</span> <span class="o">+</span> <span class="s1">&#39; -r &#39;</span> <span class="o">+</span> <span class="n">rst</span> <span class="o">+</span> <span class="s1">&#39; -x &#39;</span> <span class="o">+</span> <span class="n">nc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;prod&#39;</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">prod_fwd</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.out&#39;</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span>
            <span class="n">inpcrd</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.rst&#39;</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-i &#39;</span> <span class="o">+</span> <span class="n">inp</span> <span class="o">+</span> <span class="s1">&#39; -o &#39;</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> <span class="o">+</span> <span class="n">top</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span> <span class="n">inpcrd</span> <span class="o">+</span> <span class="s1">&#39; -r &#39;</span> <span class="o">+</span> <span class="n">rst</span> <span class="o">+</span> <span class="s1">&#39; -x &#39;</span> <span class="o">+</span> <span class="n">nc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># current_groupfile = handle_groupfile() # uncomment this line to enable splitting the halves of prod jobs up among different groupfiles (remember to comment out the &quot;flag&quot; line in handle_groupfile too)</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="n">prod_bwd</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.out&#39;</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span>
            <span class="n">inpcrd</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_bwd.rst&#39;</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.rst&#39;</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-i &#39;</span> <span class="o">+</span> <span class="n">inp</span> <span class="o">+</span> <span class="s1">&#39; -o &#39;</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> <span class="o">+</span> <span class="n">top</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span> <span class="n">inpcrd</span> <span class="o">+</span> <span class="s1">&#39; -r &#39;</span> <span class="o">+</span> <span class="n">rst</span> <span class="o">+</span> <span class="s1">&#39; -x &#39;</span> <span class="o">+</span> <span class="n">nc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;committor_analysis&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/committor_analysis.in&#39;</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>
                <span class="n">top</span> <span class="o">=</span> <span class="s1">&#39;../&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span>
                <span class="n">inpcrd</span> <span class="o">=</span> <span class="s1">&#39;../&#39;</span> <span class="o">+</span> <span class="n">name</span>
                <span class="n">rst</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst&#39;</span>
                <span class="n">nc</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-i &#39;</span> <span class="o">+</span> <span class="n">inp</span> <span class="o">+</span> <span class="s1">&#39; -o &#39;</span> <span class="o">+</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> <span class="o">+</span> <span class="n">top</span> <span class="o">+</span> <span class="s1">&#39; -c &#39;</span> <span class="o">+</span> <span class="n">inpcrd</span> <span class="o">+</span> <span class="s1">&#39; -r &#39;</span> <span class="o">+</span> <span class="n">rst</span> <span class="o">+</span> <span class="s1">&#39; -x &#39;</span> <span class="o">+</span> <span class="n">nc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="c1"># Since we&#39;re adding multiple lines here, we need to check at every iteration if a new groupfile is</span>
                <span class="c1"># required. handle_groupfile() handles this for us neatly.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">current_groupfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span><span class="p">:</span>
                    <span class="n">current_groupfile</span> <span class="o">=</span> <span class="n">handle_groupfile</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>   <span class="c1"># do not proceed with the remainder of this function</span>

    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
        <span class="c1"># init batch file</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing init batch file for &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; starting from &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init&#39;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">init_nodes</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">init_ppn</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">init_walltime</span><span class="p">,</span>
                                 <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sander&#39;</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/init.in&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init.out&#39;</span><span class="p">,</span>
                                 <span class="n">prmtop</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span> <span class="n">inpcrd</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">start_name</span><span class="p">,</span> <span class="n">rst</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span>
                                 <span class="n">nc</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init.nc&#39;</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">init_mem</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                                 <span class="n">self_name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;prod&#39;</span><span class="p">:</span>
        <span class="c1"># forward and backward simulation batch files</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing forward batch file for &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd&#39;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_nodes</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_walltime</span><span class="p">,</span>
                                 <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sander&#39;</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="n">prod_fwd</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.out&#39;</span><span class="p">,</span> <span class="n">prmtop</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span>
                                 <span class="n">inpcrd</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span> <span class="n">rst</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.rst&#39;</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">,</span>
                                 <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_mem</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                                 <span class="n">self_name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing backward batch file for &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd&#39;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_nodes</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_walltime</span><span class="p">,</span>
                                 <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sander&#39;</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="n">prod_bwd</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.out&#39;</span><span class="p">,</span> <span class="n">prmtop</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span>
                                 <span class="n">inpcrd</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_bwd.rst&#39;</span><span class="p">,</span> <span class="n">rst</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.rst&#39;</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">,</span>
                                 <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_mem</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                                 <span class="n">self_name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;committor_analysis&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">nodes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_nodes</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span><span class="p">,</span>
                                     <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_walltime</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sander&#39;</span><span class="p">,</span>
                                     <span class="n">inp</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/committor_analysis.in&#39;</span><span class="p">,</span>
                                     <span class="n">out</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">,</span> <span class="n">prmtop</span><span class="o">=</span><span class="s1">&#39;../&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span>
                                     <span class="n">inpcrd</span><span class="o">=</span><span class="s1">&#39;../&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">rst</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst&#39;</span><span class="p">,</span>
                                     <span class="n">nc</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_mem</span><span class="p">,</span>
                                     <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/committor_analysis&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">committor_analysis</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                     <span class="n">self_name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
                <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
                <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing committor analysis batch file with initial point: &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span>
                                      <span class="s1">&#39;suffix: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;lmax_&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">+</span> <span class="s1">&#39;.tpl&#39;</span><span class="p">)</span>
            <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_walltime</span><span class="p">,</span>
                                     <span class="nb">input</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">,</span>
                                     <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_mem</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">k_best</span><span class="o">=</span><span class="s1">&#39;null&#39;</span><span class="p">,</span>
                                     <span class="n">fixed</span><span class="o">=</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">cvs_in_rc</span><span class="p">),</span> <span class="n">bootstrap</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                                     <span class="n">home_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span><span class="p">,</span> <span class="n">self_name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
            <span class="c1"># k_best and fixed = &#39;null&#39; because they are ignored since running is given. Here &#39;bootstrap&#39; refers to a</span>
            <span class="c1"># separate bootstrapping algorithm within LMAX that I wrote for something else, not to the RC bootstrapping</span>
            <span class="c1"># that it going on when this code is called, so it should be turned off (set to 0).</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
                <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
                <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing bootstrap batch file: &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># This error is obsolete, as unless the code is broken in some way it should be unreachable (job type is not a user-</span>
    <span class="c1"># supplied value)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An incorrect job type </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was passed to makebatch.&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;An incorrect job type </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was passed to makebatch.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newfile</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="subbatch"><a class="viewcode-back" href="../../autosummary/atesa.subbatch.html#atesa.subbatch">[docs]</a><span class="k">def</span> <span class="nf">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;as.log&#39;</span><span class="p">,</span><span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Submit the appropriate batch file for the given thread and direction to the batch system.</span>

<span class="sd">    Has two mutually exclusive branches:</span>
<span class="sd">    - When groupfile == 0, simply constructs the name of the batch file to submit and calls interact() to do so</span>
<span class="sd">    - When groupfile &gt; 0, does nothing (as in this case, batch file submission is handled in handle_groupfile())</span>

<span class="sd">    If thread.type == &#39;committor_analysis&#39;, then the additional parameter n_shots is required to identify the number of</span>
<span class="sd">    committor analysis batch jobs to submit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thread : Thread</span>
<span class="sd">        The Thread object for which to submit the requisite file(s).</span>
<span class="sd">    direction : str</span>
<span class="sd">        Either &#39;fwd&#39;, &#39;bwd&#39;, or &#39;init&#39;, as corresponding to the desired simulation type. This option is omitted for</span>
<span class="sd">        committor analysis. Default = &#39;&#39;</span>
<span class="sd">    logfile : str</span>
<span class="sd">        Name of the logfile to write output to. This is used to redirect the output from the default logfile to ca.log</span>
<span class="sd">        when subbatch is called from rc_eval.committor_analysis(). Default = &#39;as.log&#39;</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        if groupfile &gt; 0, returns &#39;groupfile&#39;;</span>
<span class="sd">        elif direction == &#39;fwd&#39;, &#39;bwd&#39;, or &#39;init&#39;, directly passes back the output from interact(); else,</span>
<span class="sd">    list</span>
<span class="sd">        A list object containing n_shots jobid strings corresponding to the jobids of the submitted committor analysis</span>
<span class="sd">        simulations.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># just shorthand</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># todo: add support for groupfiles during committor analysis</span>
        <span class="c1"># Usually subbatch() returns a jobid, but that&#39;s not appropriate when groupfiles are used, as they submit when</span>
        <span class="c1"># they&#39;re full rather than when subbatch is called. If we&#39;re using groupfiles, this function is not needed, and</span>
        <span class="c1"># so we simply issue a return statement to break out of it without doing anything.</span>
        <span class="k">return</span> <span class="s1">&#39;groupfile&#39;</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUGMODE</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;committor_analysis&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span>
            <span class="c1"># First, check to ensure that the batch file exists</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: subbatch() was called to submit a non-existant batch file: &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
                    <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
            <span class="c1"># Return a randomly generated but non-redundant jobid string</span>
            <span class="n">random_jobid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">99999999</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">jobid</span> <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobidlist</span><span class="p">]</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]:</span>
                <span class="n">random_jobid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">random_jobid</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;committor_analysis&#39;</span><span class="p">:</span>
            <span class="c1"># As above, but a list of settings.n_shots randomly generated strings</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: subbatch() was called to submit a non-existant batch file: &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
                <span class="n">random_jobid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">))</span>
                <span class="k">while</span> <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                            <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                            <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">jobid</span> <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobidlist</span><span class="p">]</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                            <span class="n">random_jobid</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">random_jobid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_jobid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># As above, but for bootstrap-style jobs</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: subbatch() was called to submit a non-existant batch file: bootstrap_&#39;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
                <span class="n">random_jobid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">))</span>
                <span class="k">while</span> <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                                <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                                <span class="n">random_jobid</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">jobid</span> <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobidlist</span><span class="p">]</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span>
                                                 <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span> <span class="ow">or</span> \
                                <span class="n">random_jobid</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">random_jobid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999999</span><span class="p">))</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_jobid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span>

    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;committor_analysis&#39;</span><span class="p">:</span>    <span class="c1"># committor analysis branch</span>
        <span class="n">jobids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">n_shots</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Submitting job: &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ca_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">jobids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jobids</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span>      <span class="c1"># bootstrapping branch</span>
        <span class="n">jobids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Submitting job: &#39;</span> <span class="o">+</span> <span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
            <span class="n">jobids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jobids</span>
    <span class="k">else</span><span class="p">:</span>                               <span class="c1"># aimless shooting, find_ts, or EPS branch</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Submitting job: &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="spawnthread"><a class="viewcode-back" href="../../autosummary/atesa.spawnthread.html#atesa.spawnthread">[docs]</a><span class="k">def</span> <span class="nf">spawnthread</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">thread_type</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a new Thread object with the desired specifications.</span>

<span class="sd">    This is merely a shortcut function and may be deprecated in future releases in favor of defining Thread() in such a</span>
<span class="sd">    way as to make it obsolete. It ensures that Thread.name = Thread.basename + &#39;_&#39; + Thread.suffix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    basename : str</span>
<span class="sd">        The initial string shared by all files corresponding to this thread.</span>
<span class="sd">    thread_type : str</span>
<span class="sd">        Either &#39;fwd&#39;, &#39;bwd&#39;, &#39;init&#39;, or &#39;committor_analysis&#39;, to indicate the type of the next job. Default = &#39;init&#39;</span>
<span class="sd">    suffix : str</span>
<span class="sd">        The string to append to the first member of this new Thread. Should be a string containing an integer, as in</span>
<span class="sd">        suffix=&#39;1&#39;. Default = &#39;&#39;</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Thread</span>
<span class="sd">        The newly created Thread object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">new_thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span>
    <span class="n">new_thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
    <span class="n">new_thread</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">suffix</span>
    <span class="n">new_thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">thread_type</span>
    <span class="n">new_thread</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="n">basename</span>
    <span class="n">new_thread</span><span class="o">.</span><span class="n">prmtop</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">committor_analysis</span><span class="p">:</span>     <span class="c1"># committor analysis calls this function but does not have an allthreads attribute in its settings</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_thread</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>    <span class="c1"># need to evaluate the window this Thread started in and store its boundaries.</span>
        <span class="k">try</span><span class="p">:</span>            <span class="c1"># test if eps settings has been initialized yet</span>
            <span class="n">null</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: spawnthread() was called with eps_settings = True, but eps_windows has not been initialized&#39;</span><span class="p">)</span>
        <span class="n">cv_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span><span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cv</span><span class="p">]</span>  <span class="c1"># OP values as a list</span>
        <span class="n">rc_value</span> <span class="o">=</span> <span class="n">get_rc_value</span><span class="p">(</span><span class="n">cv_values</span><span class="o">=</span><span class="n">cv_values</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">:</span>   <span class="c1"># if empty_windows is empty, i.e., this is the first thread being spawned</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span> <span class="k">for</span> <span class="n">null</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: eps_dynamic_seed was given as a list, but is not of the same length as the &#39;</span>
                             <span class="s1">&#39;number of EPS windows. There are &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; EPS windows but&#39;</span>
                             <span class="s1">&#39; eps_dynamic_seed is of length &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">)))</span>
                <span class="n">window_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">[</span><span class="n">window_index</span><span class="p">])</span>  <span class="c1"># meaning eps_dynamic_seed[window_index] more threads need to start here before it will no longer be considered &quot;empty&quot;</span>
                    <span class="n">window_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">dynamic_seed_kludge</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># see cleanthread</span>
                    <span class="n">window</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">dynamic_seed_kludge</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">dynamic_seed_kludge</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>    <span class="c1"># this attribute not having been defined yet is fine</span>
            <span class="c1"># use of inclusive inequality on both sides prevents values equal to the min or max from presenting issues</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span> <span class="o">&lt;=</span> <span class="n">rc_value</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Creating new thread starting from initial structure &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; with&#39;</span>
                                          <span class="s1">&#39; RC value &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rc_value</span><span class="p">))</span>
                <span class="n">new_thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span>
                <span class="n">new_thread</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">:</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>   <span class="c1"># set empty_windows for this window to 1 less</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_thread</span><span class="o">.</span><span class="n">rc_max</span><span class="p">:</span>     <span class="c1"># since if I check just one, it could be zero!</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: initial structure &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; has RC value (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rc_value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) outside the &#39;</span>
                     <span class="s1">&#39;defined range (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_min</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_max</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;).&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_thread</span></div>


<div class="viewcode-block" id="checkcommit"><a class="viewcode-back" href="../../autosummary/atesa.checkcommit.html#atesa.checkcommit">[docs]</a><span class="k">def</span> <span class="nf">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check a currently running Thread for commitment to either of the user-defined basins and return a string indicating</span>
<span class="sd">    the direction of that commitment, if applicable.</span>

<span class="sd">    This function loads the indicated trajectory and measures the distances indicated in the commit_fwd and commit_bwd</span>
<span class="sd">    lists to compare them against the designated cutoff values. If the user provided basin definitions that are not</span>
<span class="sd">    mutually exclusive for some reason (this is strongly cautioned against) and both conditions are met, then this</span>
<span class="sd">    function will identify commitment in the &#39;fwd&#39; direction only.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thread : Thread</span>
<span class="sd">        The Thread object whose most recent simulation is to be checked for commitment.</span>
<span class="sd">    direction : str</span>
<span class="sd">        Either &#39;fwd&#39;, &#39;bwd&#39;  or &#39;committor_analysis&#39;, to indicate which simulation to check commitment for. Note that</span>
<span class="sd">        this parameter only refers to the name of the simulation (production simulations are named with &#39;fwd&#39; or &#39;bwd&#39;</span>
<span class="sd">        to indicate the original and reversed velocities), not the value that this function returns.</span>
<span class="sd">    directory : str</span>
<span class="sd">        Path to the directory just above committor_analysis. When this parameter is not provided, the function looks for</span>
<span class="sd">        trajectories in the working directory, so this option is required for committor analysis. Default = &#39;&#39;</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Either &#39;fwd&#39; when the commit_fwd criteria are met; &#39;bwd&#39; when the commit_bwd criteria are met; or &#39;&#39; when</span>
<span class="sd">        neither are met. Alternatively, &#39;eps&#39; if eps_settings was provided (no computations are performed in this case)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">committor_directory</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>            <span class="c1"># empty if directory isn&#39;t given, so we&#39;re looking in working_directory</span>
    <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
        <span class="n">directory</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">committor_directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;committor_analysis&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">committor_analysis</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span><span class="s1">&#39;bwd&#39;</span><span class="p">,</span><span class="s1">&#39;init&#39;</span><span class="p">]:</span>  <span class="c1"># occurs when this is called by rc_eval.py or init_find_ts</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span>   <span class="c1"># in this case &#39;thread&#39; should be a string, not a Thread() object. This is sloppy.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">committor_directory</span> <span class="o">+</span> <span class="n">name</span><span class="p">):</span>  <span class="c1"># if the file doesn&#39;t exist yet, just do nothing</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">committor_directory</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">committor_directory</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">):</span>  <span class="c1"># if the file doesn&#39;t exist yet, just do nothing</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">committor_directory</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span>
                                   <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>

    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                    <span class="c1"># initialize flag for commitment; this is the value to be returned eventually</span>
    <span class="c1"># If we&#39;re doing EPS, the commitment criterion is that any of the beads reside inside the given range of RC values</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span><span class="s1">&#39;bwd&#39;</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: checkcommit() was passed an incorrect direction argument: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
        <span class="n">rc_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()):</span>                         <span class="c1"># iterate through frames</span>
            <span class="n">cv_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cv</span><span class="p">]</span>  <span class="c1"># CV values as a list</span>
            <span class="n">rc_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rc_value</span><span class="p">(</span><span class="n">cv_values</span><span class="o">=</span><span class="n">cv_values</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">))</span>
        <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>           <span class="c1"># return &#39;False&#39; if no beads are in bounds</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rc_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span><span class="p">:</span>
                <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>    <span class="c1"># return &#39;True&#39; if any of the beads are in bounds.</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1"># normal aimless shooting behavior</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">traj</span><span class="p">:</span>  <span class="c1"># catches error if the trajectory file exists but has zero frames</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t worry about this internal error; it just means that ATESA is checking for commitment in a &#39;</span>
                  <span class="s1">&#39;trajectory that doesn</span><span class="se">\&#39;</span><span class="s1">t have any frames yet, probably because the simulation has only just begun.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>     <span class="c1"># if a commitor test is passed, testing moves on to the next one.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">break</span>                   <span class="c1"># if a commitor test is not passed, all testing in this direction ends in a fail</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given for index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">fwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given for index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">fwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">commit_flag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>                <span class="c1"># only bother checking for bwd commitment if not fwd commited</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>  <span class="c1"># if a commitor test is passed, testing moves on to the next one.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">break</span>                <span class="c1"># if a commitor test is not passed, all testing in this direction ends in a fail</span>
                <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given for index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">bwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given for index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">bwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">traj</span>    <span class="c1"># to ensure cleanup of iterload object</span>

    <span class="k">return</span> <span class="n">commit_flag</span></div>


<div class="viewcode-block" id="standalone_checkcommit"><a class="viewcode-back" href="../../autosummary/atesa.standalone_checkcommit.html#atesa.standalone_checkcommit">[docs]</a><span class="k">def</span> <span class="nf">standalone_checkcommit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>   <span class="c1"># todo: delete or modify this or checkcommit() so only one is needed</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check a coordinate file for commitment to either of the user-defined basins and return a string indicating</span>
<span class="sd">    the direction of that commitment, if applicable.</span>

<span class="sd">    As checkcommit, but takes a trajectory/coordinate file name instead of a Thread.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of trajectory file to check for commitment.</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Either &#39;fwd&#39; when the commit_fwd criteria are met; &#39;bwd&#39; when the commit_bwd criteria are met; or &#39;&#39; when</span>
<span class="sd">        neither are met. Alternatively, &#39;eps&#39; if eps_settings was provided (no computations are performed in this case)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">):</span>  <span class="c1"># if the file doesn&#39;t exist, return &#39;fail&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;fail&#39;</span>

    <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">traj</span><span class="p">:</span>                            <span class="c1"># catches error if the trajectory file exists but has zero frames</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t worry about this internal error; it</span><span class="se">\&#39;</span><span class="s1">s from pytraj trying to load an empty trajectory, which ATESA can handle properly.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;fail&#39;</span>

    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                        <span class="c1"># initialize flag for commitment; this is the value to be returned eventually</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>         <span class="c1"># if a committor test is passed, testing moves on to the next one.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">break</span>                       <span class="c1"># if a committor test is not passed, all testing in this direction ends in a fail</span>
        <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given&#39;</span>
                                      <span class="s1">&#39; for index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">fwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given for index &#39;</span> <span class="o">+</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">fwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">commit_flag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>                   <span class="c1"># only bother checking for bwd commitment if not fwd commited</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> \
                        <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>     <span class="c1"># if a committor test is passed, testing moves on to the next one.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">break</span>                   <span class="c1"># if a committor test is not passed, all testing in this direction ends in a fail</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> \
                        <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was &#39;</span>
                                          <span class="s1">&#39;given for index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">bwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;An incorrect commitor definition </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1"> was given for index &#39;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in the </span><span class="se">\&#39;</span><span class="s1">bwd</span><span class="se">\&#39;</span><span class="s1"> direction.&#39;</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">traj</span>  <span class="c1"># to ensure cleanup of iterload object</span>

    <span class="k">if</span> <span class="n">commit_flag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">commit_flag</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>

    <span class="k">return</span> <span class="n">commit_flag</span></div>


<div class="viewcode-block" id="pickframe"><a class="viewcode-back" href="../../autosummary/atesa.pickframe.html#atesa.pickframe">[docs]</a><span class="k">def</span> <span class="nf">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">forked_from</span><span class="o">=</span><span class="n">Thread</span><span class="p">(),</span> <span class="n">frame</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a new restart-format coordinate file using a randomly chosen frame with index between 0 and settings.n_adjust</span>
<span class="sd">    to serve as the initial coordinates for a new simulation.</span>

<span class="sd">    This function loads the last valid trajectory from thread in the given direction in order to select a random frame.</span>
<span class="sd">    If forked_from is provided, it indicates that thread should be treated as a new Thread object but that its initial</span>
<span class="sd">    coordinates should be chosen from the forked_from Thread.</span>

<span class="sd">    If a frame argument &gt;= 0 is given, this function does not use settings.n_adjust; instead, it simply uses that frame.</span>
<span class="sd">    If frame argument &lt; 0 (which is the default), but settings.n_adjust is also negative, then the absolute value of</span>
<span class="sd">    that number is used (e.g., if settings.n_adjust = -10, the 10th frame is used).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thread : Thread or str</span>
<span class="sd">        The Thread object whose most recent simulation is to be checked for commitment. Can also be a string giving the</span>
<span class="sd">        name attribute of the trajectory to pick from. If this setting is a string, forked_from should always be used.</span>
<span class="sd">    direction : str</span>
<span class="sd">        Either &#39;fwd&#39;, &#39;bwd&#39;, or when forking, &#39;init&#39;, to indicate which simulation to pick the random frame from.</span>
<span class="sd">    forked_from : Thread</span>
<span class="sd">        A Thread object from which to draw the initial coordinates for thread. Default = Thread() (an empty Thread</span>
<span class="sd">        object, which will not be used.)</span>
<span class="sd">    frame : int</span>
<span class="sd">        Manually override the random frame picking by providing the frame index to use. Must be &gt;= 0 to be used.</span>
<span class="sd">        Default = -1</span>
<span class="sd">    suffix : int</span>
<span class="sd">        Setting only used when thread is a string. This value is incremented by one and appended to the name of the new</span>
<span class="sd">        coordinate file. Default = 1</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Filename of the newly created restart-format coordinate file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="n">Thread</span><span class="p">):</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">thread</span>   <span class="c1"># thread should be a string</span>
        <span class="n">last_valid</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c1"># only used to avoid the if last_valid == &#39;0&#39; branch if forked_from is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">last_valid</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span>

    <span class="k">if</span> <span class="n">last_valid</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>           <span class="c1"># to catch case where &#39;last_valid&#39; is still the initial shooting point because a new valid transition path has not been found</span>
        <span class="k">return</span> <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span>    <span class="c1"># will cause the new start_name to be unchanged from the previous run</span>

    <span class="k">if</span> <span class="n">frame</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frame_number</span> <span class="o">=</span> <span class="n">frame</span>
    <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">n_adjust</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frame_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">n_adjust</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frame_number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">n_adjust</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">basename</span><span class="p">:</span>    <span class="c1"># if an actual thread was given for forked_from (as opposed to the default)...</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span><span class="s1">&#39;bwd&#39;</span><span class="p">]:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">forked_from</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="n">frame_slice</span><span class="o">=</span><span class="p">(</span><span class="n">frame_number</span><span class="p">,</span><span class="n">frame_number</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">forked_from</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: pickframe() encountered unexpected direction: &#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39; during fork&#39;</span><span class="p">)</span>
        <span class="n">new_suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="n">frame_slice</span><span class="o">=</span><span class="p">(</span><span class="n">frame_number</span><span class="p">,</span><span class="n">frame_number</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">new_restart_name</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">new_suffix</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span>
    <span class="n">pytraj</span><span class="o">.</span><span class="n">write_traj</span><span class="p">(</span><span class="n">new_restart_name</span><span class="p">,</span><span class="n">traj</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># multi because not including this option seems to keep it on anyway, so I want to be consistent</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_restart_name</span> <span class="o">+</span> <span class="s1">&#39;.1&#39;</span><span class="p">,</span><span class="n">new_restart_name</span><span class="p">)</span>     <span class="c1"># I don&#39;t quite know why, but pytraj appends &#39;.1&#39; to the filename, so this removes it.</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span> <span class="c1"># I sort of anticipate this breaking down the line, so this block is here to help handle that.</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: tried renaming .rst7.1 file &#39;</span> <span class="o">+</span> <span class="n">new_restart_name</span> <span class="o">+</span> <span class="s1">&#39;.1 with .rst7&#39;</span>
                                  <span class="s1">&#39;, but encountered OSError exception. Either you ran out of storage space, or this is&#39;</span>
                                  <span class="s1">&#39; a possible indication of an unexpected pytraj version?&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_restart_name</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error: pickframe did not produce the restart file for the next shooting move. &#39;</span>
                                      <span class="s1">&#39;Please ensure that you didn</span><span class="se">\&#39;</span><span class="s1">t run out of storage space, and then raise this &#39;</span>
                                      <span class="s1">&#39;issue on GitHub to let me know!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: pickframe did not produce the restart file for the next shooting move. Please ensure that &#39;</span>
                     <span class="s1">&#39;you didn</span><span class="se">\&#39;</span><span class="s1">t run out of storage space, and then raise this issue on GitHub to let me know!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: it tentatively looks like this should be okay, as the desired file was still created.&#39;</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">basename</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Forking &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; from &#39;</span> <span class="o">+</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">forked_from</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39;.nc, frame number &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_number</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initializing next shooting point from shooting run &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39; in &#39;</span> <span class="o">+</span> <span class="n">direction</span> <span class="o">+</span> <span class="s1">&#39; direction, frame number &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_number</span><span class="p">))</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">traj</span>  <span class="c1"># to ensure cleanup of iterload object</span>

    <span class="k">return</span> <span class="n">new_restart_name</span></div>


<div class="viewcode-block" id="get_rc_value"><a class="viewcode-back" href="../../autosummary/atesa.get_rc_value.html#atesa.get_rc_value">[docs]</a><span class="k">def</span> <span class="nf">get_rc_value</span><span class="p">(</span><span class="n">cv_values</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate and return reaction coordinate value based on a given list of cv_values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cv_values : list</span>
<span class="sd">        A list of values for the CVs to plug into the RC equation as needed (same order as candidateops)</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">equation</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">rc_definition</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">literal_ops</span><span class="p">:</span>
        <span class="n">local_candidateops</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">]</span>  <span class="c1"># to fix error where candidateops has unexpected format</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">local_candidateops</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">include_qdot</span><span class="p">:</span>
        <span class="n">qdot_factor</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># to include qdot CVs if applicable</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qdot_factor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">qdot_factor</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">])))):</span>  <span class="c1"># for each candidate cv... (reversed to avoid e.g. &#39;CV10&#39; -&gt; &#39;cv_values[0]0&#39;)</span>
        <span class="n">equation</span> <span class="o">=</span> <span class="n">equation</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;CV&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;cv_values[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">equation</span><span class="p">))</span></div>


<div class="viewcode-block" id="cleanthread"><a class="viewcode-back" href="../../autosummary/atesa.cleanthread.html#atesa.cleanthread">[docs]</a><span class="k">def</span> <span class="nf">cleanthread</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset thread parameters in preparation for the next step of aimless shooting after the previous one has completed.</span>
<span class="sd">    Add the next step to the itinerary if appropriate. Also write to history and output files, implement fork if</span>
<span class="sd">    necessary, and terminate the thread if any of the termination criteria are met, among other housekeeping tasks.</span>

<span class="sd">    This function should be called after every thread step is completed to handle it in the appropriate manner. In</span>
<span class="sd">    effect, it serves as a housekeeping function to take care of all the important details that are checked for after</span>
<span class="sd">    every &quot;prod&quot; step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thread : Thread</span>
<span class="sd">        The Thread object that just completed a move.</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># global candidateops</span>

    <span class="k">def</span> <span class="nf">report_rc_values</span><span class="p">(</span><span class="n">coord_file</span><span class="p">):</span>
        <span class="c1"># Simple function for outputting the RC values for a given trajectory traj to the eps_results.out file</span>
        <span class="c1"># todo: replace use of traj with simple evaluation of eps_fwd/bwd variable, depending on direction argument? (Unimportant, optimization only)</span>
        <span class="n">rc_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;.rst&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span> <span class="ow">or</span> <span class="s1">&#39;.rst7&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span><span class="p">:</span>
            <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;.rst7&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span><span class="p">:</span>
            <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;.nc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: cleanthread.report_rc_values() encountered a file of unknown format: &#39;</span> <span class="o">+</span> <span class="n">coord_file</span><span class="p">)</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fileformat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()):</span>                         <span class="c1"># iterate through frames of traj</span>
            <span class="n">cv_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cv</span><span class="p">]</span>  <span class="c1"># CV values as a list</span>
            <span class="n">rc_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rc_value</span><span class="p">(</span><span class="n">cv_values</span><span class="o">=</span><span class="n">cv_values</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rc_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span><span class="p">:</span>     <span class="c1"># only write to output if the bead is inside the window</span>
                <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rc_values</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>                <span class="c1"># EPS behavior</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>  <span class="c1"># if this move was accepted...</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd_la</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span>  <span class="c1"># update &quot;last accepted&quot; eps_(b/f)wd attributes for this thread</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd</span>
        <span class="c1"># Store RC values for each frame in both the fwd and bwd trajectories of the last-accepted move, regardless of</span>
        <span class="c1"># whether that&#39;s this newest one or an old one.</span>
        <span class="n">fwd_rc_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bwd_rc_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">init_rc_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd_la</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>     <span class="c1"># latter requirement because we need at least one accepted trajectory before we can start reporting values</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fwd_rc_values</span> <span class="o">=</span> <span class="n">report_rc_values</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Debug: Failed on &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span>
                         <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  thread.eps_fwd_la = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd_la</span><span class="p">)</span>
                         <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  thread.last_valid = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span><span class="p">)</span>
                         <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  thread.suffix = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bwd_rc_values</span> <span class="o">=</span> <span class="n">report_rc_values</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Debug: Failed on &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span>
                         <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  thread.eps_fwd_la = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd_la</span><span class="p">)</span>
                         <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  thread.last_valid = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span><span class="p">)</span>
                         <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  thread.suffix = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">init_rc_value</span> <span class="o">=</span> <span class="n">report_rc_values</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">)</span>
        <span class="c1"># Finally, handle dynamic seeding:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span> <span class="ow">and</span> <span class="p">(</span><span class="kc">True</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">):</span> <span class="c1"># is this last boolean required? I think maybe yes because I&#39;m using pickframe()?</span>
            <span class="n">rc_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">bwd_rc_values</span><span class="p">))</span> <span class="o">+</span> <span class="n">init_rc_value</span> <span class="o">+</span> <span class="n">fwd_rc_values</span>
            <span class="n">start_bead</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">rc_value</span> <span class="ow">in</span> <span class="n">rc_values</span><span class="p">:</span>
                <span class="n">start_bead</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span> <span class="o">&lt;=</span> <span class="n">rc_value</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">):</span>
                        <span class="c1"># Write a new coordinate file from the appropriate trajectory</span>
                        <span class="c1"># todo: this is so ugly because I didn&#39;t design pickframe() to help make a new thread with an unknown initial structure. Can I clean this up somehow?</span>
                        <span class="k">if</span> <span class="n">start_bead</span> <span class="o">&lt;=</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span><span class="p">:</span>         <span class="c1"># use la values since pickframe uses the la trajectory</span>
                            <span class="n">structure</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">-</span> <span class="n">start_bead</span><span class="p">),</span> <span class="n">forked_from</span><span class="o">=</span><span class="n">thread</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>     <span class="c1"># &quot;frame&quot; should be zero-indexed</span>
                            <span class="n">suffix</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">debug_dir</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
                            <span class="n">debug_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">-</span> <span class="n">start_bead</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">start_bead</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># the initial coordinates</span>
                            <span class="n">structure</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">forked_from</span><span class="o">=</span><span class="n">thread</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                            <span class="n">suffix</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">debug_dir</span> <span class="o">=</span> <span class="s1">&#39;init_fwd&#39;</span>
                            <span class="n">debug_frame</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                        <span class="k">else</span><span class="p">:</span>                                       <span class="c1"># inside the fwd trajectory</span>
                            <span class="n">structure</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start_bead</span> <span class="o">-</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">forked_from</span><span class="o">=</span><span class="n">thread</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>   <span class="c1"># &quot;frame&quot; should be zero-indexed</span>
                            <span class="n">suffix</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">debug_dir</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
                            <span class="n">debug_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_bead</span> <span class="o">-</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">dynamic_seed_kludge</span> <span class="o">=</span> <span class="n">window</span>   <span class="c1"># forces spawnthread to place this thread in the correct window in the case where it could fit into two due to overlap</span>
                        <span class="n">newthread</span> <span class="o">=</span> <span class="n">spawnthread</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># spawn a new thread with the default settings</span>
                        <span class="c1">#newthread.last_valid = &#39;0&#39;              # so that if the first shooting point does not result in a valid transition path, shooting will begin from the TS guess</span>
                        <span class="n">newthread</span><span class="o">.</span><span class="n">prmtop</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span>    <span class="c1"># set prmtop filename for the thread</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newthread</span><span class="p">)</span>    <span class="c1"># submit it to the itinerary</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Empty EPS window with upper and lower boundaries: &#39;</span> <span class="o">+</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span><span class="p">]</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span>
                                                  <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; has been&#39;</span>
                                                  <span class="s1">&#39; seeded using bead &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_bead</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; from shooting move &#39;</span> <span class="o">+</span>
                                                  <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;. Debug information:&#39;</span><span class="p">)</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  fwd_rc_values = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fwd_rc_values</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  bwd_rc_values = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bwd_rc_values</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  rc_values = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rc_values</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  start_bead = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_bead</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  pickframe trajectory = &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">debug_dir</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  frame from trajectory = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">debug_frame</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  structure = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">structure</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  new empty_windows = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">))</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>  <span class="c1"># standard aimless shooting behavior</span>
        <span class="c1"># Record result of forward trajectory in output file. This is done regardless of whether the shooting point was</span>
        <span class="c1"># accepted; accept/reject is for keeping the sampling around the separatrix, but even rejected points are valid</span>
        <span class="c1"># for calculating the reaction coordinate so long as they committed to a basin!</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
            <span class="n">basin</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
        <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
            <span class="n">basin</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basin</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: thread commit1 flag took on unexpected value: &#39;</span> <span class="o">+</span> <span class="n">basin</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">This is a weird error.&#39;</span>
                     <span class="s1">&#39; Please raise this issue on GitHub along with your ATESA input file!&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">basin</span> <span class="o">+</span> <span class="s1">&#39; &lt;- &#39;</span> <span class="o">+</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Write last result to history</span>
    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>
    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1"># failure of one or both halves of shooting move</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">code</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;history/&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">history_line</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">history_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/history&#39;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/history&#39;</span><span class="p">)</span>   <span class="c1"># delete old (apparently broken) history directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/history&#39;</span><span class="p">)</span>     <span class="c1"># make a new one</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/history&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;history/&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">history_line</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">history_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Shooting run &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; finished with fwd trajectory result: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">+</span> <span class="s1">&#39; and bwd trajectory result: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;, as well as init result: &#39;</span> <span class="o">+</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">))</span>   <span class="c1"># todo: should probably save an init_commit attribute to threads to avoid checking commitment on init for a second time here.</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; has a current acceptance ratio of: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, or &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Implementation of fork. Makes (fork - 1) new threads from successful runs and adds them to the itinerary. The new</span>
    <span class="c1"># threads do not inherit anything from their parents except starting point and history.</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">fork</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">fork</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pick_dir</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pick_dir</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
            <span class="n">newthread</span> <span class="o">=</span> <span class="n">spawnthread</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">newthread</span><span class="o">.</span><span class="n">prmtop</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span>
            <span class="n">newthread</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">newthread</span><span class="p">,</span> <span class="n">pick_dir</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="c1">#newthread.last_valid = &#39;0&#39;</span>
            <span class="n">newthread</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newthread</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>    <span class="c1"># EPS behavior</span>
        <span class="n">start_bead</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span><span class="p">)</span>
        <span class="c1"># Thread has attributes eps_fwd and eps_bwd telling me how long the fwd and bwd trajectories are...</span>
        <span class="k">if</span> <span class="n">start_bead</span> <span class="o">&lt;=</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span><span class="p">:</span>         <span class="c1"># use la values since pickframe uses the la trajectory</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">-</span> <span class="n">start_bead</span><span class="p">),</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>         <span class="c1"># &quot;frame&quot; should be zero-indexed</span>
        <span class="k">elif</span> <span class="n">start_bead</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># the initial coordinates</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span>
        <span class="k">else</span><span class="p">:</span>                                       <span class="c1"># inside the fwd trajectory</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start_bead</span> <span class="o">-</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd_la</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>     <span class="c1"># &quot;frame&quot; should be zero-indexed</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span> <span class="o">-</span> <span class="n">start_bead</span>           <span class="c1"># set new eps_fwd and _bwd to keep string length the same</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span> <span class="o">-</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">-</span> <span class="mi">1</span>   <span class="c1"># extra -1 to account for starting point</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>               <span class="c1"># normal aimless shooting behavior</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># This is necessary to avoid an issue where acceptance ratios fall off as sampling progresses. See Mullen et al. 2015 (Easy TPS) SI.</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pick_dir</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pick_dir</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">==</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">always_new</span><span class="p">:</span>  <span class="c1"># pick a new starting point if the last move was a success</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start_name</span> <span class="o">=</span> <span class="n">pickframe</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">pick_dir</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>    <span class="c1"># init trajectory is never used for anything, so delete it if settings.cleanup == True</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_init.nc&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_init.nc&#39;</span><span class="p">)</span>

    <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># this line required if eps_settings is given, redundant otherwise</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># this line required if eps_settings is given, redundant otherwise</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">null</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_bookkeep</span>  <span class="c1"># to throw AttributeError if not set up to do bootstrapping</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_flag</span> <span class="o">=</span> <span class="n">handle_bootstrap</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># handles tasks associated with bootstrapping</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bootstrapped reaction coordinates agree to within given tolerance. No &#39;</span>
                                              <span class="s1">&#39;further jobs will be submitted by this instance of ATESA, but currently&#39;</span>
                                              <span class="s1">&#39;running jobs will be allowed to finish. To perform more sampling, submit&#39;</span>
                                              <span class="s1">&#39; a new ATESA job in the same working directory with restart = True&#39;</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">max_fails</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;max_fails&#39;</span>     <span class="c1"># the thread dies because it has failed too many times in a row</span>
    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">max_moves</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;max_moves&#39;</span>     <span class="c1"># the thread dies because it has performed too many total moves</span>
    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">max_accept</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;max_accept&#39;</span>    <span class="c1"># the thread dies because it has accepted too many moves</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_flag</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>        <span class="c1"># the thread lives and moves to next step</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>  <span class="c1"># the thread lives and moves to next step</span>

    <span class="c1"># Write a status file to indicate the acceptance ratio and current status of every thread.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;status.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; acceptance ratio: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, or &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;%</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>   <span class="c1"># Since any thread that hasn&#39;t completed a move yet has total_moves = 0</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; acceptance ratio: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, or 0%</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Status: move &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39; queued</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Status: move &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39; running</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max_accept&#39;</span><span class="p">,</span><span class="s1">&#39;max_moves&#39;</span><span class="p">,</span><span class="s1">&#39;max_fails&#39;</span><span class="p">]:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Status: terminated after move &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39; due to termination criterion: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  Status: crashed during move &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="candidatevalues"><a class="viewcode-back" href="../../autosummary/atesa.candidatevalues.html#atesa.candidatevalues">[docs]</a><span class="k">def</span> <span class="nf">candidatevalues</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">frame</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the candidate CV values from the initial coordinates of the most recent step of the given thread.</span>

<span class="sd">    This function is only capable of returning order parameter rate of change values when the literal_ops Boolean is</span>
<span class="sd">    True. This will change in future versions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coord_file : str</span>
<span class="sd">        The name of the coordinate file to evaluate.</span>
<span class="sd">    frame : int</span>
<span class="sd">        Frame number to evaluate instead of the most recent, zero-indexed. Must be &gt;= 0 to be used.</span>
<span class="sd">    reduce : bool</span>
<span class="sd">        Boolean indicating whether or not to reduce the candidate OP values based on the contents of rc_minmax. This</span>
<span class="sd">        should be used when the output of candidatevalues is being used to calculate an RC value.</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A space-separated series of CV values in the same order as they are given in candidate_cv, followed</span>
<span class="sd">        by their rates of change per 1/20.455 ps (unit of time in Amber) in the same order if applicable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">reduce_op</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">local_index</span><span class="p">):</span>
        <span class="c1"># Return the reduced value of the index&#39;th OP with un-reduced value input (an int or float).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]),</span><span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]),</span><span class="nb">float</span><span class="p">):</span>  <span class="c1"># if there&#39;s a blank entry in rc_minmax</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: rc_definition contains reference to OP&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; without a corresponding entry in rc_minmax&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>                         <span class="c1"># if there&#39;s no entry at all</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: rc_definition contains reference to OP&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; without a corresponding entry in rc_minmax&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">input</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">rc_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">rc_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;.rst&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span> <span class="ow">or</span> <span class="s1">&#39;.rst7&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span><span class="p">:</span>
        <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;.rst7&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span><span class="p">:</span>
        <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;.nc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: candidatevalues() encountered a file of unsupported file extension (only .rst, .rst7, and .nc &#39;</span>
                 <span class="s1">&#39;are supported): &#39;</span> <span class="o">+</span> <span class="n">coord_file</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">frame</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fileformat</span><span class="p">,</span> <span class="n">frame_slice</span><span class="o">=</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">frame</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">include_qdot</span><span class="p">:</span>
            <span class="n">pytraj</span><span class="o">.</span><span class="n">write_traj</span><span class="p">(</span><span class="s1">&#39;temp_frame.rst7&#39;</span><span class="p">,</span><span class="n">traj</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">velocity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">)</span>    <span class="c1"># multi because not including this option seems to keep it on anyway, so I want to be consistent</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;temp_frame.rst7.1&#39;</span><span class="p">,</span><span class="s1">&#39;temp_frame.rst7&#39;</span><span class="p">)</span>    <span class="c1"># I don&#39;t quite know why, but pytraj appends &#39;.1&#39; to the filename, so this removes it.</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>                                         <span class="c1"># I sort of anticipate this breaking down the line, so this block is here to help handle that.</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: tried renaming .rst7.1 file temp_frame.rst7.1 with .rst7,&#39;</span>
                                          <span class="s1">&#39; but encountered OSError exception. Either you ran out of storage space, or &#39;</span>
                                          <span class="s1">&#39;this is a possible indication of an unexpected pytraj version?&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;temp_frame.rst7&#39;</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: pickframe did not produce the restart file for the next shooting move. Please ensure that you didn</span><span class="se">\&#39;</span><span class="s1">t run out of storage space, and then raise this issue on GitHub to let me know!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: it tentatively looks like this should be okay, as the desired file was still created.&#39;</span><span class="p">)</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fileformat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">increment_coords</span><span class="p">():</span>
        <span class="c1"># Modified from revvels() to increment coordinate values by velocities, rather than reversing velocities.</span>
        <span class="c1"># Returns the name of the newly-created coordinate file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">coord_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;temp_frame.rst7&#39;</span>
        <span class="n">byline</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;-*[0-9.]+&#39;</span><span class="p">)</span>           <span class="c1"># regex to match numbers including decimals and negatives</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">byline</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># number of atoms indicated on second line of .rst file</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;temp.rst&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;temp.rst&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">newline</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>                                          <span class="c1"># line of coordinates</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vels</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">byline</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))])</span>     <span class="c1"># corresponding velocities</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: candidatevalues.increment_coords() encountered an IndexError. This is caused &#39;</span>
                             <span class="s1">&#39;by attempting to read qdot values from a coordinate file lacking velocity information, or&#39;</span>
                             <span class="s1">&#39; else by that file being truncated. The offending file is: &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
                <span class="c1"># Sometimes items in coords or vels &#39;stick together&#39; at a negative sign (e.g., &#39;-1.8091748-112.6420521&#39;)</span>
                <span class="c1"># This next loop is just to split them up</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>                     <span class="c1"># length of string representing this coordinate</span>
                    <span class="n">replace_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">vels</span><span class="p">[</span><span class="n">index</span><span class="p">]))[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">replace_string</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                        <span class="n">replace_string</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span>
                    <span class="n">newline</span> <span class="o">=</span> <span class="n">newline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">replace_string</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;temp.rst&#39;</span>

    <span class="c1"># Implementation of explicit, to directly interpret user-supplied OPs</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">literal_ops</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">:</span>
            <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">evaluation</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">include_qdot</span><span class="p">:</span>    <span class="c1"># want to save values for later</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">evaluation</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">reduce</span><span class="p">:</span>
                <span class="n">evaluation</span> <span class="o">=</span> <span class="n">reduce_op</span><span class="p">(</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">local_index</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">evaluation</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">include_qdot</span><span class="p">:</span>        <span class="c1"># if True, then we want to include rate of change for every OP, too</span>
            <span class="c1"># Strategy here is to write a new temporary .rst7 file by incrementing all the coordinate values by their</span>
            <span class="c1"># corresponding velocity values, load it as a new iterload object, and then rerun our analysis on that.</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">increment_coords</span><span class="p">(),</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
            <span class="n">local_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">:</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">evaluation</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">-</span> <span class="n">values</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>     <span class="c1"># Subtract value 1/20.455 ps earlier from value of op</span>
                <span class="k">if</span> <span class="n">reduce</span><span class="p">:</span>
                    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">reduce_op</span><span class="p">(</span><span class="n">evaluation</span><span class="p">,</span><span class="n">local_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">))</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">evaluation</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="c1"># todo: test implementation of include_qdot for this branch of candidatevalues</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">local_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>          <span class="c1"># settings.candidateops contains dihedrals</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">local_index</span><span class="p">]:</span>      <span class="c1"># if this OP is a dihedral</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">dihedral</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">]:</span>    <span class="c1"># if this OP is an angle</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>                           <span class="c1"># if this OP is a distance</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>        <span class="c1"># settings.candidateops contains angles but not dihedrals</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">]:</span>      <span class="c1"># if this OP is an angle</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>                           <span class="c1"># if this OP is a distance</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>                               <span class="c1"># settings.candidateops contains only distances</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">include_qdot</span><span class="p">:</span>    <span class="c1"># want to save values for later</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">reduce</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">reduce_op</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">local_index</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">include_qdot</span><span class="p">:</span>        <span class="c1"># if True, then we want to include rate of change for every OP, too</span>
            <span class="c1"># Strategy here is to write a new temporary .rst7 file by incrementing all the coordinate values by their</span>
            <span class="c1"># corresponding velocity values, load it as a new iterload object, and then rerun our analysis on that.</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">increment_coords</span><span class="p">(),</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">local_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># settings.candidateops contains dihedrals</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">local_index</span><span class="p">]:</span>  <span class="c1"># if this OP is a dihedral</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">dihedral</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                           <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                           <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                           <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">]:</span>  <span class="c1"># if this OP is an angle</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                        <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                        <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if this OP is a distance</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                           <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># settings.candidateops contains angles but not dihedrals</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">]:</span>  <span class="c1"># if this OP is an angle</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                        <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                        <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if this OP is a distance</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                           <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># settings.candidateops contains only distances</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">local_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                       <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">local_index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">values</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>     <span class="c1"># Subtract value 1/20.455 ps earlier from value of op</span>
                <span class="k">if</span> <span class="n">reduce</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">reduce_op</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">local_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="k">del</span> <span class="n">traj</span>  <span class="c1"># to ensure cleanup of iterload object</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="revvels"><a class="viewcode-back" href="../../autosummary/atesa.revvels.html#atesa.revvels">[docs]</a><span class="k">def</span> <span class="nf">revvels</span><span class="p">(</span><span class="n">thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a new restart-format coordinate file by multiplying the velocity values from the most recent &quot;\*_init_fwd.rst&quot;</span>
<span class="sd">    file belonging to thread by -1.</span>

<span class="sd">    This function provides the initial coordinates for &quot;bwd&quot; production simulations in ATESA. Velocities in</span>
<span class="sd">    .rst files are stored in groups of three just like coordinates and directly following them. This function finds the</span>
<span class="sd">    place where coordinates end and velocities begin by reading the number of atoms listed on the 2nd line of the .rst</span>
<span class="sd">    file, dividing it by two, and then navigating to the line immediately after that plus three (since coordinates begin</span>
<span class="sd">    on line 3) and minus one (because of indexing).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    thread : Thread</span>
<span class="sd">        The Thread object that owns the \*_init_fwd.rst file to reverse.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">byline</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[-0-9.]+&#39;</span><span class="p">)</span>        <span class="c1"># regex to match numbers including decimals and negatives</span>
    <span class="n">pattern2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\s[-0-9.]+&#39;</span><span class="p">)</span>     <span class="c1"># regex to match numbers including decimals and negatives, with one space in front</span>
    <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">byline</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of atoms indicated on second line of .rst file</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span>                              <span class="c1"># appropriate for n_atoms is odd; offset helps avoid modifying the box line</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>               <span class="c1"># if n_atoms is even...</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>                          <span class="c1"># appropriate for n_atoms is even</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_bwd.rst&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init_bwd.rst&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">:</span>      <span class="c1"># if this line is a velocity line</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="n">line</span>
            <span class="k">for</span> <span class="n">vel</span> <span class="ow">in</span> <span class="n">pattern2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">newline</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">vel</span><span class="p">:</span>
                    <span class="n">newline</span> <span class="o">=</span> <span class="n">newline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># replace &#39; -magnitude&#39; with &#39;  magnitude&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newline</span> <span class="o">=</span> <span class="n">newline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">)</span>    <span class="c1"># replace &#39; magnitude&#39; with &#39;-magnitude&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>                                                           <span class="c1"># if not a velocity line</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="main_loop"><a class="viewcode-back" href="../../autosummary/atesa.main_loop.html#atesa.main_loop">[docs]</a><span class="k">def</span> <span class="nf">main_loop</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform the sequence of simulations constituting a full ATESA run.</span>

<span class="sd">    This is the primary runtime loop of this program, from which all the helper functions are called (either</span>
<span class="sd">    directly or by one another). Along with the helper functions, it builds Threads, submits them to the batch system,</span>
<span class="sd">    monitors them for completion, and handles the output and next steps once they&#39;ve finished.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Contains all the settings dictating how this function operates.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These bash commands will be used later to cancel jobs after they&#39;ve completed</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;pbs&#39;</span><span class="p">:</span>
        <span class="n">cancel_command</span> <span class="o">=</span> <span class="s1">&#39;qdel&#39;</span>
    <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
        <span class="n">cancel_command</span> <span class="o">=</span> <span class="s1">&#39;scancel&#39;</span>

    <span class="c1"># global itinerary                # get global variables from outer scope so they are accessible by main_loop()</span>
    <span class="c1"># global running                  # honestly I don&#39;t know why this is necessary, but removing these lines breaks it</span>
    <span class="c1"># global allthreads</span>

    <span class="k">while</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>     <span class="c1"># while either list has contents...</span>
        <span class="n">itin_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
        <span class="n">run_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">]</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Current status...</span><span class="se">\n</span><span class="s1"> Itinerary: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">itin_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Running: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_names</span><span class="p">))</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Submitting jobs in itinerary...&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">local_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># set place in itinerary to -1</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>   <span class="c1"># for each thread that&#39;s ready for its next step...</span>
            <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>                <span class="c1"># increment place in itinerary</span>
            <span class="n">makebatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span><span class="n">settings</span><span class="p">)</span>      <span class="c1"># make the necessary batch file</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>    <span class="c1"># submit batch file and collect jobID into thread</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>     <span class="c1"># if this setting exists and isn&#39;t zero</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>    <span class="c1"># simulation doesn&#39;t run, so it doesn&#39;t satisfy acceptance criterion</span>
                <span class="k">except</span><span class="p">:</span>                             <span class="c1"># if this setting doesn&#39;t exist (normal aimless shooting behavior)</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>                                <span class="c1"># repeat for bwd half of thread</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">local_index</span><span class="p">])</span>    <span class="c1"># move itinerary element to next in running</span>

        <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty itinerary</span>

        <span class="n">itin_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
        <span class="n">run_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">]</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Current status...</span><span class="se">\n</span><span class="s1"> Itinerary: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">itin_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Running: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_names</span><span class="p">))</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Once again, the fact that groupfile support was only added late in development means that this is a bit ugly.</span>
        <span class="c1"># This while loop serves the same purpose as the one directly following it, but works in terms of groupfile jobs</span>
        <span class="c1"># instead of individual batch jobs. I can&#39;t think of an easy way to unify them, but this is an opportunity for</span>
        <span class="c1"># polish if I ever rewrite this software from the ground up.</span>
        <span class="c1">#</span>
        <span class="c1"># I&#39;m not implementing flexible-length shooting for groupfiles, since it should be exceedingly rare anyway for</span>
        <span class="c1"># every job in a groupfile to be committed substantially before the job is ending anyway, assuming the user</span>
        <span class="c1"># chooses prod_walltime judiciously.</span>
        <span class="c1"># todo: implement EPS for groupfile &gt; 0</span>
        <span class="k">while</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>
            <span class="n">handle_groupfile</span><span class="p">()</span>                          <span class="c1"># update settings.groupfile_list</span>
            <span class="k">for</span> <span class="n">groupfile_data</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile_list</span><span class="p">:</span>       <span class="c1"># for each list element [&lt;NAME&gt;, &lt;STATUS&gt;, &lt;CONTENTS&gt;, &lt;TIME&gt;]</span>
                <span class="k">if</span> <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>    <span class="c1"># if this groupfile task has status &quot;completed&quot;</span>
                    <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>     <span class="c1"># iterate through thread.name + &#39;_&#39; + thread.type of jobs in groupfile</span>
                        <span class="k">if</span> <span class="s1">&#39;init&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>                        <span class="c1"># do this for all init jobs in this groupfile</span>
                            <span class="c1"># Need to get ahold of the thread this init job represents...</span>
                            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>       <span class="c1"># can&#39;t say this is surely the best way to do this...</span>
                                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">revvels</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>     <span class="c1"># make the initial .rst file for the bwd trajectory</span>
                                        <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;prod&#39;</span>
                                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Job completed: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init</span><span class="se">\n</span><span class="s1">Adding &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; forward and backward jobs to itinerary&#39;</span><span class="p">)</span>
                                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>   <span class="c1"># when revvels can&#39;t find the init .rst file</span>
                                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Thread &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; crashed: initialization did not produce a restart file.&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">restart_on_crash</span><span class="p">:</span>
                                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">restart_on_crash = False; thread will not restart&#39;</span><span class="p">)</span>
                                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">restart_on_crash</span><span class="p">:</span>
                                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">restart_on_crash = True; resubmitting thread to itinerary&#39;</span><span class="p">)</span>
                                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                            <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                                            <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>
                                            <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;prod&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>                        <span class="c1"># do this for all prod jobs in this groupfile</span>
                            <span class="c1"># todo: figure out how to tolerate only one of the halves of a prod job showing up in a given groupfile</span>
                            <span class="c1"># Need to get ahold of the thread this prod job represents...</span>
                            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>       <span class="c1"># can&#39;t say this is surely the best way to do this...</span>
                                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
                                    <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># check for commitment in fwd job</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span><span class="p">:</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
                                    <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># check for commitment in bwd job</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span><span class="p">:</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
                                    <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                                    <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">+=</span> <span class="mi">1</span>       <span class="c1"># increment fails in a row regardless of outcome</span>
                                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>  <span class="c1"># valid EPS move</span>
                                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># reset fail count to zero if this move was accepted</span>
                                    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">!=</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>  <span class="c1"># valid transition path, update &#39;last_valid&#39; attribute</span>
                                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># reset fail count to zero if this move was accepted</span>
                                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>  <span class="c1"># shooting move did not pass, so we can immediately delete the trajectories</span>
                                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                                    <span class="n">cleanthread</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                    <span class="n">groupfile_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;processed&#39;</span>     <span class="c1"># to indicate that this completed groupfile job has been handled</span>

            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;restart.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># dump information required to restart ATESA</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>                          <span class="c1"># delay 60 seconds before checking for job status again</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                <span class="n">acceptances</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">/</span> <span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Itinerary and running lists are empty.</span><span class="se">\n</span><span class="s1">Aimless shooting is complete! &#39;</span>
                    <span class="s1">&#39;The highest acceptance ratio for any thread was &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">acceptances</span><span class="p">))</span> <span class="o">+</span>
                    <span class="s1">&#39;%.</span><span class="se">\n</span><span class="s1">See as.out in the working directory for results.&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Itinerary and running lists are empty.</span><span class="se">\n</span><span class="s1">Equilibrium path sampling is complete!&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">See eps_results.out in the working directory for results.&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">while</span> <span class="n">settings</span><span class="o">.</span><span class="n">groupfile</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>   <span class="c1"># while itinerary is empty and not in groupfile mode</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="s1">&#39;queue&#39;</span><span class="p">,</span><span class="n">settings</span><span class="p">)</span>     <span class="c1"># retrieves string containing jobids of running and queued jobs</span>
            <span class="n">local_index</span> <span class="o">=</span> <span class="mi">0</span>                         <span class="c1"># set place in running to 0</span>
            <span class="k">while</span> <span class="n">local_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">):</span>  <span class="c1"># while instead of for to control indexing manually</span>
                <span class="n">thread</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>  <span class="c1"># if a submitted job is no longer running</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">revvels</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>  <span class="c1"># make the initial .rst file for the bwd trajectory</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">])</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;prod&#39;</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;prod&#39;</span>
                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Job completed: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_init</span><span class="se">\n</span><span class="s1">Adding &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; forward and backward jobs to itinerary&#39;</span><span class="p">)</span>
                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>  <span class="c1"># when revvels can&#39;t find the init .rst file</span>
                            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Thread &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; crashed: initialization did not produce a restart file.&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">restart_on_crash</span><span class="p">:</span>
                                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">restart_on_crash = False; thread will not restart&#39;</span><span class="p">)</span>
                                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">restart_on_crash</span><span class="p">:</span>
                                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">restart_on_crash = True; resubmitting thread to itinerary&#39;</span><span class="p">)</span>
                                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">])</span>
                                <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>
                        <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>
                        <span class="n">local_index</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># to keep index on track after deleting an entry</span>
                    <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;prod&#39;</span><span class="p">:</span>
                        <span class="c1"># fwd trajectory exited before passing a commitor test, either walltime or other error</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># check one last time</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span><span class="p">:</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>  <span class="c1"># if one of the submitted jobs no longer appears to be running</span>
                    <span class="c1"># bwd trajectory exited before passing a commitor test, either walltime or other error</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># check one last time</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span><span class="p">:</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increment place in running</span>

            <span class="n">local_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">local_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">):</span>
                <span class="n">thread</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;prod&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>     <span class="c1"># &#39;and not eps_settings&#39; ensures EPS jobs only get checked for &#39;commitment&#39; when they exit naturally.</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;bwd&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">cancel_command</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># doesn&#39;t do anything, I think</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">cancel_command</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># doesn&#39;t do anything, I think</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">jobid2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>
                        <span class="n">local_index</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># to keep index on track after deleting an entry</span>
                        <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increment fails in a row regardless of outcome</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>   <span class="c1"># valid EPS move</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span> <span class="ow">or</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                                <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span>
                                <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># reset fail count to zero if this move was accepted</span>
                        <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">!=</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>  <span class="c1"># valid transition path, update &#39;last_valid&#39; attribute</span>
                            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">failcount</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># reset fail count to zero if this move was accepted</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">cleanup</span><span class="p">:</span>  <span class="c1"># shooting move did not pass, so we can immediately delete the trajectories</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                        <span class="n">cleanthread</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
                <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;restart.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">),</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># dump information required to restart ATESA</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUGMODE</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>                                  <span class="c1"># delay 60 seconds before checking for job status again</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">find_ts</span><span class="p">:</span>
                <span class="n">acceptances</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">/</span> <span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Itinerary and running lists are empty.</span><span class="se">\n</span><span class="s1">Aimless shooting is complete! &#39;</span>
                                          <span class="s1">&#39;The highest acceptance ratio for any thread was &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">acceptances</span><span class="p">))</span> <span class="o">+</span>
                                          <span class="s1">&#39;%.</span><span class="se">\n</span><span class="s1">See as.out in the working directory for results.&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">find_ts</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Itinerary and running lists are empty.</span><span class="se">\n</span><span class="s1">Equilibrium path sampling is complete!&#39;</span>
                                          <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">See eps_results.out in the working directory for results.&#39;</span><span class="p">)</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">find_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">:</span>
                <span class="n">acceptances</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">thread</span><span class="o">.</span><span class="n">accept_moves</span> <span class="o">/</span> <span class="n">thread</span><span class="o">.</span><span class="n">total_moves</span><span class="p">)</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([(</span><span class="n">acceptance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">acceptance</span> <span class="ow">in</span> <span class="n">acceptances</span><span class="p">]):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Itinerary and running lists are empty.</span><span class="se">\n</span><span class="s1">find_ts is complete! &#39;</span>
                                                      <span class="s1">&#39;The highest acceptance ratio for any thread was &#39;</span> <span class="o">+</span>
                                                      <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">acceptances</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%.</span><span class="se">\n</span><span class="s1">See status.txt in the working &#39;</span>
                                                      <span class="s1">&#39;directory for results.&#39;</span><span class="p">)</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">find_ts_loop</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_progress"><a class="viewcode-back" href="../../autosummary/atesa.update_progress.html#atesa.update_progress">[docs]</a><span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Progress&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a dynamic progress bar to stdout.</span>

<span class="sd">    Credit to Brian Khuu from stackoverflow, https://stackoverflow.com/questions/3160699/python-progress-bar</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    progress : float</span>
<span class="sd">        A number between 0 and 1 indicating the fractional completeness of the bar. A value under 0 represents a &#39;halt&#39;.</span>
<span class="sd">        A value at 1 or bigger represents 100%.</span>
<span class="sd">    message : str</span>
<span class="sd">        The string to precede the progress bar (so as to indicate what is progressing)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">barLength</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Modify this to change the length of the progress bar</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;error: progress var must be float</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Halt...</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Done!</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">barLength</span> <span class="o">*</span> <span class="n">progress</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;: [</span><span class="si">{0}</span><span class="s2">] </span><span class="si">{1}</span><span class="s2">% </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="n">block</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">barLength</span> <span class="o">-</span> <span class="n">block</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">progress</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">status</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="cv_analysis_func"><a class="viewcode-back" href="../../autosummary/atesa.cv_analysis_func.html#atesa.cv_analysis_func">[docs]</a><span class="k">def</span> <span class="nf">cv_analysis_func</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce a subdirectory inside the working directory containing a file for each thread, which in turn contain columns</span>
<span class="sd">    for every CV, giving the value of that CV vs. thread step.</span>

<span class="sd">    Obtains information on thread history by reading through the log file.</span>
<span class="sd">    Note that this will produce redundant points between different files wherever threads fork from a single starting</span>
<span class="sd">    point. Even if there is no forking in the log file, if there is degeneracy initial points will be shared.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First make the directory</span>
    <span class="n">dirName</span> <span class="o">=</span> <span class="s1">&#39;cv_analysis&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirName</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>  <span class="c1"># delete old working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>    <span class="c1"># make a new one</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>

    <span class="n">pattern1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*_[0-9]+_1$&#39;</span><span class="p">)</span>   <span class="c1"># pattern matching strings ending in _X_1 where X is any integer</span>
    <span class="n">pattern2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*_1$&#39;</span><span class="p">)</span>          <span class="c1"># pattern matching strings ending in _1</span>
    <span class="n">pattern3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*_[0-9]+$&#39;</span><span class="p">)</span>      <span class="c1"># pattern matching strings ending in _X where X is any integer</span>

    <span class="n">update_progress</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Tabulating thread histories&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">keeptrack</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># initialize nested list for keeping track of contributors to each file</span>
    <span class="c1"># Next, comb through the log file and dynamically write files as necessary.</span>
    <span class="k">for</span> <span class="n">logline</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="c1"># Strategy here is to look for lines starting with &quot;Writing forward batch file for &quot;, followed by the name.</span>
        <span class="c1"># Choose which file to append to by working backwards through the name string.</span>
        <span class="k">if</span> <span class="s1">&#39;Writing forward batch file for &#39;</span> <span class="ow">in</span> <span class="n">logline</span><span class="p">:</span>
            <span class="n">thisname</span> <span class="o">=</span> <span class="n">logline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Writing forward batch file for &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>    <span class="c1"># get thread name including suffix</span>
            <span class="n">thisname</span> <span class="o">=</span> <span class="n">thisname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">thisname</span><span class="p">):</span>        <span class="c1"># move name ends in _X_1 where X is any integer</span>
                <span class="c1"># Strip _X_1 from thisname</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">thisname</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">keeptrack_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">keeptrack</span><span class="p">:</span>    <span class="c1"># if already found a move obtainable by omitting the _X_1, forked from that</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
                        <span class="n">keeptrack</span><span class="p">[</span><span class="n">keeptrack_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisname</span><span class="p">)</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">keeptrack_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>                <span class="c1"># else this is a top-level move</span>
                    <span class="n">keeptrack</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">thisname</span><span class="p">])</span>  <span class="c1"># make new entry in keeptrack for this top-level move</span>
            <span class="k">elif</span> <span class="n">pattern2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">thisname</span><span class="p">):</span>  <span class="c1"># move name ends in _1</span>
                <span class="n">keeptrack</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">thisname</span><span class="p">])</span>      <span class="c1"># make new entry in keeptrack for this top-level move</span>
            <span class="k">elif</span> <span class="n">pattern3</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">thisname</span><span class="p">):</span>  <span class="c1"># ends in _X where X is any integer (non-1, since 1 is caught above)</span>
                <span class="c1"># Subtract one from terminal integer in thisname</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">thisname</span>
                <span class="n">terminal_int</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">terminal_int</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">terminal_int</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">terminal_int</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">terminal_int</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># do the actual subtraction</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">terminal_int</span>
                <span class="n">keeptrack_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">keeptrack</span><span class="p">:</span>    <span class="c1"># if already found a move obtainable by subtracting one, continued from that</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
                        <span class="n">keeptrack</span><span class="p">[</span><span class="n">keeptrack_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisname</span><span class="p">)</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">keeptrack_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>                <span class="c1"># else something went wrong</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: shooting move in &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">logfile</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">thisname</span> <span class="o">+</span> <span class="s1">&#39; doesn</span><span class="se">\&#39;</span><span class="s1">t fit any thread. Is the log file&#39;</span>
                         <span class="s1">&#39; corrupted or incomplete? If you</span><span class="se">\&#39;</span><span class="s1">re sure it</span><span class="se">\&#39;</span><span class="s1">s not, please raise a GitHub issue!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: shooting move in &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">logfile</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">thisname</span> <span class="o">+</span> <span class="s1">&#39; is formatted incorrectly. Is the log file &#39;</span>
                         <span class="s1">&#39;corrupted or incomplete? If you</span><span class="se">\&#39;</span><span class="s1">re sure it</span><span class="se">\&#39;</span><span class="s1">s not, please raise a GitHub issue!&#39;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">lines</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Tabulating thread histories&#39;</span><span class="p">)</span>

    <span class="n">update_progress</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Writing CV output files&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keeptrack</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">keeptrack</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirName</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;cvs.out&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Obtain each CV for each file in thread, report them row-by-row for each file</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">thread</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;_init_fwd.rst&#39;</span>
                <span class="n">cvs</span> <span class="o">=</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cvs</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">lines</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Writing CV output files&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="zip_for_transfer_func"><a class="viewcode-back" href="../../autosummary/atesa.zip_for_transfer_func.html#atesa.zip_for_transfer_func">[docs]</a><span class="k">def</span> <span class="nf">zip_for_transfer_func</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify the files necessary to continue aimless shooting and/or analysis from the current state and zip them up for</span>
<span class="sd">    transfer to another directory or filesystem.</span>

<span class="sd">    The goal of this function is to make it easy to transfer the minimum amount of data from one directory or HPC</span>
<span class="sd">    cluster to another without losing any functionality with regard to further aimless shooting path sampling or future</span>
<span class="sd">    analysis scripts like committor analysis or equilibrium path sampling. It uses the zipfile and zlib libraries.</span>

<span class="sd">    The files to be transfered include: shooting point coordinate files; trajectory files for last-accepted moves for</span>
<span class="sd">    each Thread; the restart pickle file itself; the parameter/topology file; and the log and output files. Files from</span>
<span class="sd">    previous analysis runs, like rc_eval.out files or committor analysis directories, are excluded.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">zipfile</span>
    <span class="kn">import</span> <span class="nn">zlib</span>     <span class="c1"># necessary to use ZIP_DEFLATED (gzip-compatible) compression</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;transfer.zip&#39;</span><span class="p">):</span>  <span class="c1"># delete existing archive it is exists</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting existing transfer.zip&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;transfer.zip&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Zipping necessary files from working directory: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
    <span class="n">update_progress</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Zipping&#39;</span><span class="p">)</span>

    <span class="n">transfer_zip</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">&#39;transfer.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>             <span class="c1"># define empty zip file</span>
    <span class="n">num_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">))</span>         <span class="c1"># for progress bar</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>                                                       <span class="c1"># for progress bar</span>

    <span class="c1"># Flags indicating successful zipping of each component</span>
    <span class="n">flag_pkl</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flag_log</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flag_out</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flag_top</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">):</span>             <span class="c1"># walk through contents of working_directory</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">):</span>                          <span class="c1"># shooting move coordinate files</span>
            <span class="n">transfer_zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">compress_type</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>  <span class="c1"># add to archive with zlib compression</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">])</span> <span class="ow">or</span>\
             <span class="p">(</span><span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">last_valid</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]):</span>
            <span class="n">transfer_zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">compress_type</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>  <span class="c1"># add to archive with zlib compression</span>
        <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;restart.pkl&#39;</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;as.out&#39;</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">:</span>
            <span class="n">transfer_zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">compress_type</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>  <span class="c1"># add to archive with zlib compression</span>
            <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;restart.pkl&#39;</span><span class="p">:</span>
                <span class="n">flag_pkl</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
                <span class="n">flag_log</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;as.out&#39;</span><span class="p">:</span>
                <span class="n">flag_out</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">:</span>
                <span class="n">flag_top</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">num_files</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Zipping&#39;</span><span class="p">)</span>

    <span class="c1"># todo: technically could check if these things are present first, save some time, especially when a lot of data is at hand.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag_pkl</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not zip restart.pkl. Check that it is present and accessible in the working directory.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">flag_log</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not zip &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">logfile</span> <span class="o">+</span> <span class="s1">&#39;. Check that it is present and accessible in the working directory.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">flag_out</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not zip as.out. Check that it is present and accessible in the working directory.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">flag_top</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not zip topology file &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span> <span class="o">+</span> <span class="s1">&#39;. Check that it is present and accessible in the working directory.&#39;</span><span class="p">)</span>

    <span class="c1"># Don&#39;t forget to add completed halves of shooting moves that are still running, should any exist</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding partially-completed shooting move data...&#39;</span><span class="p">)</span>
    <span class="n">update_progress</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Zipping&#39;</span><span class="p">)</span>
    <span class="n">num_threads</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span><span class="p">):</span>
            <span class="n">transfer_zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">,</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span><span class="p">):</span>
            <span class="n">transfer_zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">,</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">num_threads</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Zipping&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="initialize_eps"><a class="viewcode-back" href="../../autosummary/atesa.initialize_eps.html#atesa.initialize_eps">[docs]</a><span class="k">def</span> <span class="nf">initialize_eps</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize global settings for EPS runs. This is only called once in the code (in the if __name__ == &#39;__main__&#39;</span>
<span class="sd">    section) but is pulled into a separate function here for the sake of cleanliness and unit testing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">n_windows</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">traj_length</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_settings</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># used when setting eps_min/max values, not in defining eps_windows</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">traj_length</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: in eps_settings, traj_length is not divisible by k_beads&#39;</span><span class="p">)</span>
    <span class="n">eps_in_template</span> <span class="o">=</span> <span class="s1">&#39;eps_in.tpl&#39;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">eps_in_template</span><span class="p">)</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">nstlim</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">settings</span><span class="o">.</span><span class="n">traj_length</span> <span class="o">/</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span><span class="p">)),</span>
                                 <span class="n">ntwx</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">traj_length</span> <span class="o">/</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span><span class="p">)))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/eps&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">window_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">rc_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">settings</span><span class="o">.</span><span class="n">n_windows</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">+</span> <span class="n">window_width</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">n_windows</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">+</span> <span class="n">window_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">n_windows</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">restart</span><span class="p">:</span>  <span class="c1"># since if restart, this file should already exist; overwrites for resample</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Lower boundary of RC window; Upper boundary; RC value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: restart = True and this is an EPS run, but eps_results.out was not found in the working &#39;</span>
                 <span class="s1">&#39;directory: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">handle_bootstrap</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle tasks associated with bootstrapping convergence of the reaction coordinate produced by LMAX.</span>

<span class="sd">    This function has branching behavior depending on what&#39;s going on when it&#39;s called:</span>

<span class="sd">    If the variable settings.bootstrap_flag == True, it will just return True without running any jobs. This is so that</span>
<span class="sd">    once bootstrapping has returned True once, more tests will not be run even when handle_bootstrap() is called again.</span>

<span class="sd">    Else, if no bootstraping jobs are running or queued, it will call makebatch() and subbatch() to build and submit</span>
<span class="sd">    batch jobs that will run atesa_lmax.py on the current as.out file and on settings.bootstrap_n bootstrapped versions</span>
<span class="sd">    of that file that this function will build.</span>

<span class="sd">    Else, if those jobs are running or queued, it will return False.</span>

<span class="sd">    Else, if those jobs have finished since the last time it was called, it will compare the results using the</span>
<span class="sd">    subfunction compare_rcs() and return a flag identifying whether the RCs are converged or not.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the bootstrapped RCs agree with the full-data RC; False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">compare_rcs</span><span class="p">(</span><span class="n">rcs</span><span class="p">):</span>
        <span class="c1"># Compares the RCs passed to it as strings in the list object rcs, where each object in rcs is a string that</span>
        <span class="c1"># can be interpreted as an RC. Returns True if the RCs all contain the same CVs and each of their coefficients</span>
        <span class="c1"># is within settings.bootstrap_threshold of the all-data value; False otherwise.</span>
        <span class="c1"># Each RC should be formatted as: coeff0 + coeff1*CV1 +/- coeff2*CV2 +/- ..., where coeffN is a positive float.</span>
        <span class="c1"># The first RC in rcs should be the all-data RC.</span>
        <span class="c1"># First, split each RC object into a sublist of terms</span>
        <span class="n">splitrcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="n">rcs</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">,</span> <span class="s1">&#39;+ -&#39;</span><span class="p">)</span>  <span class="c1"># force all operations to be addition while preserving negatives</span>
            <span class="n">splitrcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; + &#39;</span><span class="p">))</span>
        <span class="c1"># Iterate through RCs in splitrcs and check agreement criteria</span>
        <span class="n">alldata_values</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
        <span class="n">bare_term_flag</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># for bookkeeping of coefficients without CVs</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">splitrcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">alldata_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alldata_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bare_term_flag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">bare_term_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: handle_bootstrap.compare_rcs() was passed an RC with more than a single term &#39;</span>
                             <span class="s1">&#39;lacking a corresponding CV. This is probably developer error, not user error. As such, &#39;</span>
                             <span class="s1">&#39;please raise an issue on GitHub (https://github.com/team-mayes/atesa) including your &#39;</span>
                             <span class="s1">&#39;input file and this error message. The offending RC is: &#39;</span> <span class="o">+</span> <span class="n">splitrcs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="n">splitrcs</span><span class="p">:</span>
            <span class="n">bare_term_flag</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># for bookkeeping of coefficients without CVs</span>
            <span class="n">term_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">rc</span><span class="p">:</span>
                <span class="n">term_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alldata_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># CV absent from reference</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bare_term_flag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">bare_term_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: handle_bootstrap.compare_rcs() was passed an RC with more than a single term &#39;</span>
                                 <span class="s1">&#39;lacking a corresponding CV. This is probably developer error, not user error. As such&#39;</span>
                                 <span class="s1">&#39;, please raise an issue on GitHub (https://github.com/team-mayes/atesa) including &#39;</span>
                                 <span class="s1">&#39;your input file and this error message. The offending RC is: &#39;</span> <span class="o">+</span> <span class="n">rc</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">alldata_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">term_index</span><span class="p">])</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_threshold</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="n">term</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">alldata_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">term_index</span><span class="p">])</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_threshold</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># coefficient outside of reference range</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Only happens if every other check above was passed</span>

    <span class="c1"># Check that a previous call to handle_bootstrap hasn&#39;t already returned True</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Check that bootstrapping jobs aren&#39;t currently running or queued</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="s1">&#39;queue&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_jobids</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check bookkeeping variable settings.bootstrap_bookkeep to determine whether the last-submitted bootstrapping jobs</span>
    <span class="c1"># (if they exist) have been checked for agreement yet.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_bookkeep</span><span class="p">:</span>
        <span class="c1"># Obtain results and check for agreement</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_bookkeep</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">rcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">this_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">this_rc</span> <span class="o">=</span> <span class="n">this_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                        <span class="c1"># the RC is given on the last line of the output file</span>
            <span class="n">this_rc</span> <span class="o">=</span> <span class="n">this_rc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Final RC: &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>     <span class="c1"># to remove the bit that comes before the actual RC string</span>
            <span class="n">rcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_rc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compare_rcs</span><span class="p">(</span><span class="n">rcs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create and submit new bootstrap input files/batch files</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_bookkeep</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">asoutlines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">len_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">asoutlines</span><span class="p">)</span>
        <span class="n">temp_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">()</span>      <span class="c1"># make a temporary thread object to pass to makebatch</span>
        <span class="n">temp_thread</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;bootstrap&#39;</span>
        <span class="n">makebatch</span><span class="p">(</span><span class="n">temp_thread</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c1"># This makes files named &#39;bootstrap_&#39; + str(settings.len_data) + &#39;_&#39; + str(i) + &#39;.&#39; + settings.batch_system for</span>
        <span class="c1"># i in range [0, settings.bootstrap_n], each of which takes as its input file the same thing but with file</span>
        <span class="c1"># extension .in instead. Before subbatch, I have to make those files!</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_0.in&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_n</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;bootstrap_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">null</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="p">):</span>
                    <span class="n">line_index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">len_data</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">asoutlines</span><span class="p">[</span><span class="n">line_index</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">bootstrap_jobids</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">Thread</span><span class="p">(),</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="init_find_ts"><a class="viewcode-back" href="../../autosummary/atesa.init_find_ts.html#atesa.init_find_ts">[docs]</a><span class="k">def</span> <span class="nf">init_find_ts</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span><span class="n">start_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize and perform jobs for constructing transition state guesses from the provided input coordinate files. The</span>
<span class="sd">    resulting guesses should be passed back to if __name__ == &#39;__main__&#39; and interpreted as if they were user-supplied</span>
<span class="sd">    transition state structures.</span>

<span class="sd">    This function produces unique transition state guesses dynamically by comparing the settings.commit_fwd and</span>
<span class="sd">    settings.commit_bwd entries against the corresponding values in the supplied structure (only one is permitted),</span>
<span class="sd">    writing new simulation input files with bond-length constraints to gently force the system to cross from the basin</span>
<span class="sd">    it began in to the other one, running and monitoring those simulations, and then harvesting key frames from within</span>
<span class="sd">    those trajectories where the relevant bond lengths are at intermediate values. The value of int(settings.find_ts)</span>
<span class="sd">    determines the number of unique forced trajectories that are performed and harvested from.</span>

<span class="sd">    The produced coordinates are by no means guaranteed to be good transition state guesses, and indeed most will not</span>
<span class="sd">    be. Once the guesses are produced, they are automatically used to seed aimless shooting runs. Good transition state</span>
<span class="sd">    guesses will be those that have good (maybe 30-50%) acceptance ratios during this step. The user should submit</span>
<span class="sd">    find_ts ATESA runs with the expectation of obtaining transition state guesses, and then perform separate ATESA runs</span>
<span class="sd">    using the good guesses obtained by find_ts as input coordinates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>
<span class="sd">    start_name : list</span>
<span class="sd">        A one-length list containing a string indicating the name of the initial coordinate file to develop the</span>
<span class="sd">        transition state guess from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    start_name_out : list</span>
<span class="sd">        A list containing strings corresponding to the names of the newly produced transition state guesses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First step is to identify the basin that the provided structure is in and throw an error if it&#39;s in neither.</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initializing find_ts transition state search.&#39;</span><span class="p">)</span>
    <span class="n">commit</span> <span class="o">=</span> <span class="n">standalone_checkcommit</span><span class="p">(</span><span class="n">start_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">settings</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">commit</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the coordinates provided during a find_ts run must represent a structure in either the fwd &#39;</span>
                 <span class="s1">&#39;or bwd basin, but the coordinate file: &#39;</span> <span class="o">+</span> <span class="n">start_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; is in neither. If it is a transition &#39;</span>
                 <span class="s1">&#39;state guess, you should set &quot;find_ts = 0&quot; (default)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">commit</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
        <span class="n">other_basin_define</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_bwd</span>
        <span class="n">dir_to_check</span> <span class="o">=</span> <span class="s1">&#39;bwd&#39;</span>
    <span class="k">elif</span> <span class="n">commit</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
        <span class="n">other_basin_define</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">commit_define_fwd</span>
        <span class="n">dir_to_check</span> <span class="o">=</span> <span class="s1">&#39;fwd&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: internal error in checkcommit(); did not return valid output.&#39;</span><span class="p">)</span>
    <span class="c1"># Then write the restraint file</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing restraint file find_ts_restraints.DISANG&#39;</span><span class="p">)</span>
    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;find_ts_restraints.disang&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># initialize file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;find_ts_restraints.disang&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;DISANG restraint file produced by ATESA with find_ts &gt; 0 to produce transition state guesses</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">def_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_basin_define</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># additional distance to add to basin definition to push *into* basin rather than to its edge</span>
            <span class="k">if</span> <span class="n">other_basin_define</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">def_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
            <span class="k">elif</span> <span class="n">other_basin_define</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">def_index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp;rst</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  iat=&#39;</span> <span class="o">+</span> <span class="n">other_basin_define</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">def_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">other_basin_define</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">def_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  r1=0, r2=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">other_basin_define</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">def_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, r3=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">other_basin_define</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">def_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, r4=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">other_basin_define</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">def_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  rk2=500, rk3=500,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp;end</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Check that the input file for these simulations exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;input_files/find_ts.in&#39;</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not locate input file </span><span class="se">\&#39;</span><span class="s1">find_ts.in</span><span class="se">\&#39;</span><span class="s1"> in &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;input_files&#39;</span><span class="p">)</span>
    <span class="c1"># Now write and submit the batch file(s)...</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># a list of currently running threads</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># a list of all threads regardless of status</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="s1">&#39;batch_&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">+</span> <span class="s1">&#39;.tpl&#39;</span>
    <span class="k">for</span> <span class="n">ts_job</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">find_ts</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ts_job</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_find_ts&#39;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_nodes</span><span class="p">,</span> <span class="n">taskspernode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_ppn</span><span class="p">,</span>
                                 <span class="n">walltime</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_walltime</span><span class="p">,</span>
                                 <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;sander&#39;</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/find_ts.in&#39;</span><span class="p">,</span>
                                 <span class="n">out</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.out&#39;</span><span class="p">,</span> <span class="n">prmtop</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span>
                                 <span class="n">inpcrd</span><span class="o">=</span><span class="n">start_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rst</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.rst&#39;</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.nc&#39;</span><span class="p">,</span>
                                 <span class="n">mem</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">prod_mem</span><span class="p">,</span> <span class="n">working_directory</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing barrier crossing job batch file: &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
            <span class="n">newfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">spawnthread</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;find_ts&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="o">=</span> <span class="n">subbatch</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="c1"># Every minute, check if all of the jobs have committed to the appropriate basin or otherwise terminated</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;pbs&#39;</span><span class="p">:</span>
        <span class="n">cancel_command</span> <span class="o">=</span> <span class="s1">&#39;qdel&#39;</span>
    <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
        <span class="n">cancel_command</span> <span class="o">=</span> <span class="s1">&#39;scancel&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: invalid batch_system type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">interact</span><span class="p">(</span><span class="s1">&#39;queue&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="n">checkcommit</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;find_ts&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="n">dir_to_check</span><span class="p">:</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Barrier crossing job: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.&#39;</span> <span class="o">+</span>
                                                      <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">+</span> <span class="s1">&#39; has committed to the opposite basin and is &#39;</span>
                                                                              <span class="s1">&#39;being terminated.&#39;</span><span class="p">)</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">cancel_command</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">jobid1</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">subprocess_output</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># doesn&#39;t do anything, I think</span>
                <span class="k">elif</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="n">dir_to_check</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Barrier crossing job: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.&#39;</span> <span class="o">+</span>
                                                       <span class="n">settings</span><span class="o">.</span><span class="n">batch_system</span> <span class="o">+</span> <span class="s1">&#39; has failed to achieve crossing.&#39;</span><span class="p">)</span>
        <span class="n">local_index</span> <span class="o">=</span> <span class="mi">0</span>                                 <span class="c1"># robustly remove completed jobs from settings.running</span>
        <span class="n">done_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done_flag</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">[</span><span class="n">local_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span><span class="p">:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                <span class="n">local_index</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">local_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">local_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">running</span><span class="p">):</span>
                <span class="n">done_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># After all the jobs are finished, discard failures with a warning and harvest candidate TS&#39;s from the remainders</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_to_check</span> <span class="ow">in</span> <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">]:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: Of the (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">find_ts</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) attempt(s) at finding a transition state, none of the &#39;</span>
                 <span class="s1">&#39;initial barrier crossing trajectories reached the opposite basin. The most likely explanation is &#39;</span>
                 <span class="s1">&#39;that the definition of the target basin (&#39;</span> <span class="o">+</span> <span class="n">dir_to_check</span> <span class="o">+</span> <span class="s1">&#39;) is unsuitable for some reason. Please &#39;</span>
                 <span class="s1">&#39;check the produced trajector(y/ies) and output file(s) in the working directory (&#39;</span>
                 <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;) and either modify the basin definitions or the find_ts input file (&#39;</span>
                 <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/input_files/find_ts.in) accordingly.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">==</span> <span class="n">dir_to_check</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: find_ts thread &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; did not commit to &#39;</span>
                                                  <span class="s1">&#39;the opposite basin and is being discarded.&#39;</span><span class="p">)</span>
    <span class="c1"># Harvest TSs by inspecting values of basin-defining bond lengths vs. frame number</span>
    <span class="c1"># Since there&#39;s no fundamental requirement that the defining bond lengths in the fwd and bwd basin definitions be</span>
    <span class="c1"># the same, I&#39;ll look only at the lengths that were restrained during the find_ts barrier crossing step.</span>

    <span class="c1"># Quick helper function definition</span>
    <span class="k">def</span> <span class="nf">my_integral</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">my_list</span><span class="p">):</span>
        <span class="c1"># Evaluate a numerical integral of the data in list my_list on the range (params[0],params[1]), where the</span>
        <span class="c1"># values in params should be integers referring to indices of my_list.</span>
        <span class="n">partial_list</span> <span class="o">=</span> <span class="n">my_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">partial_list</span><span class="p">)</span>

    <span class="c1"># And aother quick function to find the bounds of my_integral that maximize its output</span>
    <span class="k">def</span> <span class="nf">my_bounds_opt</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">list_of_bounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">left_bound</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">right_bound</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">left_bound</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">right_bound</span> <span class="o">-</span> <span class="n">left_bound</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">list_of_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">left_bound</span><span class="p">,</span><span class="n">right_bound</span><span class="p">])</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">best_max</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">list_of_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">best_bounds</span> <span class="o">=</span> <span class="n">list_of_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="n">list_of_bounds</span><span class="p">:</span>
            <span class="n">this_result</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">this_result</span> <span class="o">&gt;</span> <span class="n">output</span><span class="o">.</span><span class="n">best_max</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">best_max</span> <span class="o">=</span> <span class="n">this_result</span>
                <span class="n">output</span><span class="o">.</span><span class="n">best_bounds</span> <span class="o">=</span> <span class="n">bounds</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_find_ts.nc&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="n">this_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">def_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_basin_define</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">this_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pytraj</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">other_basin_define</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">def_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">other_basin_define</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">def_index</span><span class="p">]))</span>  <span class="c1"># appends a list of distances for this traj to this_lengths</span>
        <span class="c1"># Now look for the TS by identifying the region in the trajectory with all of the bond lengths at intermediate</span>
        <span class="c1"># values (say, 0.25 &lt; X &lt; 0.75 on a scale of 0 to 1), preferably for several frames in a row.</span>
        <span class="n">norm_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scored_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lengths</span> <span class="ow">in</span> <span class="n">this_lengths</span><span class="p">:</span>
            <span class="n">normd</span> <span class="o">=</span> <span class="p">[(</span><span class="n">this_len</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">lengths</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">lengths</span><span class="p">))</span> <span class="k">for</span> <span class="n">this_len</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">]</span> <span class="c1"># normalize lengths to between 0 and 1</span>
            <span class="n">norm_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normd</span><span class="p">)</span>
            <span class="n">scored_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="o">-</span><span class="p">(</span><span class="n">this_len</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.0625</span><span class="p">)</span> <span class="k">for</span> <span class="n">this_len</span> <span class="ow">in</span> <span class="n">normd</span><span class="p">])</span>            <span class="c1"># scored normalized lengths on parabola</span>
        <span class="n">sum_of_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scored_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>       <span class="c1"># sum together scores from each distance at each frame</span>
            <span class="n">sum_of_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">([[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scored_lengths</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scored_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]))][</span><span class="n">frame_index</span><span class="p">]))</span>
        <span class="c1"># Now I want to find the boundaries between which the TS is most likely to reside. To do this I&#39;ll perform a 2D</span>
        <span class="c1"># optimization on the integral to find the continuous region that is most positively scored</span>
        <span class="n">opt_result</span> <span class="o">=</span> <span class="n">my_bounds_opt</span><span class="p">(</span><span class="n">my_integral</span><span class="p">,</span> <span class="n">sum_of_scores</span><span class="p">)</span>
        <span class="c1"># If all of sum_of_scores is negative we still want to find a workable max. Also, if there are fewer than five</span>
        <span class="c1"># candidate frames we want to test more than that. Either way, shift scores up by 0.1 and try again:</span>
        <span class="k">while</span> <span class="n">opt_result</span><span class="o">.</span><span class="n">best_max</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">sum_of_scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sum_of_scores</span><span class="p">]</span>
            <span class="n">opt_result</span> <span class="o">=</span> <span class="n">my_bounds_opt</span><span class="p">(</span><span class="n">my_integral</span><span class="p">,</span> <span class="n">sum_of_scores</span><span class="p">)</span>
        <span class="c1"># opt_result.best_bounds now contains the frame indices bounding the region of interest. I want to use pytraj to</span>
        <span class="c1"># extract each of these frames as a .rst7 coordinate file and return their names. I&#39;ll put a cap on the number</span>
        <span class="c1"># of frames that this is done for at, say, 50, so as to avoid somehow ending up with a huge number of candidate</span>
        <span class="c1"># TS structures to test.</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">find_ts thread &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; contains &#39;</span> <span class="o">+</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                                          <span class="s1">&#39; candidate transition state frames&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; of which 50 with the closest possible approximation of even spacing &#39;</span>
                                              <span class="s1">&#39;will be extracted for testing.&#39;</span><span class="p">)</span>
            <span class="n">frame_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;, all of which will be extracted for testing.&#39;</span><span class="p">)</span>
            <span class="n">frame_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="n">frame_indices</span><span class="p">:</span>
            <span class="n">pytraj</span><span class="o">.</span><span class="n">write_traj</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">frame_indices</span><span class="o">=</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7.1&#39;</span><span class="p">,</span>
                          <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: attempted to write file &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7, but was unable to. Please ensure that you have adequate &#39;</span>
                             <span class="s1">&#39;permissions to write to the working directory: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;debug_&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;opt_result.best_bounds: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_bounds</span><span class="p">)</span> <span class="o">+</span>
                                                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">opt_result.best_max: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt_result</span><span class="o">.</span><span class="n">best_max</span><span class="p">)</span> <span class="o">+</span>
                                                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">sum_of_scores: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sum_of_scores</span><span class="p">))</span>


    <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># clean up running and allthreads before handing off back to main code</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">find_ts transition state search complete! Passing &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">))</span> <span class="o">+</span>
                                      <span class="s1">&#39; candidate transition state structures forward for testing.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="find_ts_loop"><a class="viewcode-back" href="../../autosummary/atesa.find_ts_loop.html#atesa.find_ts_loop">[docs]</a><span class="k">def</span> <span class="nf">find_ts_loop</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpret results of a failed find_ts loop (which consists of submitting TS guesses to main_loop, having all threads</span>
<span class="sd">    terminate, and having no acceptances in any thread) and respond accordingly. This function will either write new</span>
<span class="sd">    TS guesses in an attempt to obtain a working TS, or communicate helpfully with the user, depending on the results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : Namespace</span>
<span class="sd">        Global settings Namespace object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">basename</span> <span class="ow">in</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_find_ts&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">find_ts</span><span class="p">))]:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="p">[</span><span class="n">this_thread</span> <span class="k">for</span> <span class="n">this_thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="k">if</span> <span class="n">basename</span> <span class="ow">in</span> <span class="n">this_thread</span><span class="o">.</span><span class="n">basename</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">history_str</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>     <span class="c1"># get just the result code from each move in this thread</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.rst7&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>   <span class="c1"># index from original init_find_ts trajectory</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="s1">&#39;F&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>   <span class="c1"># threads went backward but never forward</span>
            <span class="n">new_indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">this_index</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">this_index</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">if</span>
                           <span class="p">(</span><span class="n">this_index</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">traj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_indices</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="n">new_indices</span><span class="p">:</span>
                    <span class="n">pytraj</span><span class="o">.</span><span class="n">write_traj</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span>
                                      <span class="n">frame_indices</span><span class="o">=</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7.1&#39;</span><span class="p">,</span>
                                  <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">):</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: attempted to write file &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span>
                                     <span class="s1">&#39;.rst7, but was unable to. Please ensure that you have adequate permissions to &#39;</span>
                                     <span class="s1">&#39;write to the working directory: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">find_ts thread &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; failed to produce a transition &#39;</span>
                                                 <span class="s1">&#39;state for reason: unable to obtain commitment to forward basin during&#39;</span>
                                                  <span class="s1">&#39; aimless shooting. This is a strange error and may indicate highly &#39;</span>
                                                  <span class="s1">&#39;non-convergent simulation settings. If this error occurs multiple &#39;</span>
                                                  <span class="s1">&#39;times, the user is encouraged to manually inspect the simulations &#39;</span>
                                                  <span class="s1">&#39;produced for this thread for errors or unusual behavior.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="s1">&#39;B&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>  <span class="c1"># threads went forward but never backward</span>
            <span class="n">new_indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">this_index</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">this_index</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">if</span>
                           <span class="p">(</span><span class="n">this_index</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_indices</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="n">new_indices</span><span class="p">:</span>
                    <span class="n">pytraj</span><span class="o">.</span><span class="n">write_traj</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span>
                                      <span class="n">frame_indices</span><span class="o">=</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7.1&#39;</span><span class="p">,</span>
                                  <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">):</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: attempted to write file &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span>
                                     <span class="s1">&#39;, but was unable to. Please ensure that you have adequate permissions to &#39;</span>
                                     <span class="s1">&#39;write to the working directory: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">find_ts thread &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; failed to produce a transition &#39;</span>
                                                 <span class="s1">&#39;state for reason: unable to obtain commitment to backward basin &#39;</span>
                                                 <span class="s1">&#39;during aimless shooting. This is a strange error and may indicate &#39;</span>
                                                 <span class="s1">&#39;highly non-convergent simulation settings. If this error occurs &#39;</span>
                                                 <span class="s1">&#39;multiple times, the user is encouraged to manually inspect the &#39;</span>
                                                 <span class="s1">&#39;simulations produced for this thread for errors or unusual behavior.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>     <span class="c1"># some threads went only forward and some went only backwards</span>
            <span class="n">nested_history</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="p">[</span><span class="n">this_thread</span> <span class="k">for</span> <span class="n">this_thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="k">if</span> <span class="n">basename</span> <span class="ow">in</span> <span class="n">this_thread</span><span class="o">.</span><span class="n">basename</span><span class="p">]:</span>
                <span class="n">temp_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">history_str</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                    <span class="n">temp_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">nested_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_results</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;F&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;B&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">or</span>
                   <span class="p">(</span><span class="s1">&#39;B&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;F&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="ow">and</span>\
                   <span class="n">indices</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">indices</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                        <span class="n">pytraj</span><span class="o">.</span><span class="n">write_traj</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span>
                                          <span class="n">frame_indices</span><span class="o">=</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>

                            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7.1&#39;</span><span class="p">,</span>
                                      <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">):</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: attempted to write file &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span>
                                         <span class="s1">&#39;, but was unable to. Please ensure that you have adequate permissions to &#39;</span>
                                         <span class="s1">&#39;write to the working directory: &#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.rst7&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span><span class="p">]:</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Structure &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">index_index</span><span class="p">])</span>
                                                      <span class="o">+</span> <span class="s1">&#39;.rst7 appears to be a suitable TS, but may have a very low &#39;</span>
                                                      <span class="s1">&#39;acceptance ratio.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="s1">&#39;F&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;B&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">or</span>
                     <span class="p">(</span><span class="s1">&#39;B&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;F&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_history</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="ow">and</span>\
                     <span class="ow">not</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">index_index</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">indices</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Trajectory &#39;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; appears to have a transition state&#39;</span>
                                                      <span class="s1">&#39; between frames &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">index_index</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span>
                                                      <span class="nb">str</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">index_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;. You may be able to improve the&#39;</span>
                                                      <span class="s1">&#39; ability of find_ts to obtain this transition state by reducing &#39;</span>
                                                      <span class="s1">&#39;the simulation step size or steps between writes to the output &#39;</span>
                                                      <span class="s1">&#39;trajectory in find_ts.in.&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">spawnthread</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># spawn a new thread with default settings</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">topology</span>                               <span class="c1"># set prmtop filename for the thread</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>                               <span class="c1"># submit it to the itinerary</span>

    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">find_ts transition loop complete. Passing &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">))</span> <span class="o">+</span>
                                          <span class="s1">&#39; more candidate transition state structures forward for testing.&#39;</span><span class="p">)</span>
        <span class="n">main_loop</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>     <span class="c1"># pass back to main_loop having added new jobs to itinerary</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unable to produce a structure with non-zero acceptance ratio from the &#39;</span>
                                          <span class="s1">&#39;supplied initial guess and given settings. Perhaps a different initial &#39;</span>
                                          <span class="s1">&#39;structure, more relaxed termination criteria, or other change would help. &#39;</span>
                                          <span class="s1">&#39;Exiting.&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>              <span class="c1"># not an error, per se.</span></div>



<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../autosummary/atesa.main.html#atesa.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize settings object and call the appropriate functions in accordance with user-defined options.</span>

<span class="sd">    This function is only called in the event that atesa.py is run directly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">settings</span>

    <span class="c1"># Get directory from which the code was called</span>
    <span class="n">called_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c1"># Parse arguments from command line using argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Perform aimless shooting according to the settings given in the input file.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-O&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;flag indicating that existing working_directory should be overwritten if it exists.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;input_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;as.in&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;input filename; see documentation for format. Default=</span><span class="se">\&#39;</span><span class="s1">as.in</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;working_directory&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/as_working&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;working directory. Default=</span><span class="se">\&#39;</span><span class="s1">`pwd`/as_working</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>  <span class="c1"># Retrieves arguments as a dictionary object</span>

    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>  <span class="c1"># parser drops dashes (&#39;-&#39;) from variable names, so the -i argument is retrieved as such</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># handles inconsistency in format when the default value is used vs. when a value is given</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: cannot find input file </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">input_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">input_file_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># if i skips blank lines</span>
    <span class="n">input_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Initialize default values for all the input file entries, to be overwritten by the actual contents of the file</span>
    <span class="n">initial_structure</span> <span class="o">=</span> <span class="s1">&#39;inpcrd&#39;</span>  <span class="c1"># Initial structure filename</span>
    <span class="n">if_glob</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True if initial_structure should be interpreted as a glob argument</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="s1">&#39;prmtop&#39;</span>  <span class="c1"># Topology filename</span>
    <span class="n">n_adjust</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Max number of frames by which each step deviates from the previous one</span>
    <span class="n">batch_system</span> <span class="o">=</span> <span class="s1">&#39;slurm&#39;</span>  <span class="c1"># Batch system type, Slurm or PBS</span>
    <span class="n">working_directory</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>  <span class="c1"># Working directory for aimless shooting calculations</span>
    <span class="n">restart_on_crash</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># If a thread crashes during initialization, should it be resubmitted?</span>
    <span class="n">max_fails</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Number of unaccepted shooting moves before a thread is killed; a negative value means &quot;no max&quot;</span>
    <span class="n">max_moves</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Number of moves with any result permitted before the thread is terminated</span>
    <span class="n">max_accept</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Number of accepted moves permitted before the thread is terminated</span>
    <span class="n">degeneracy</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of duplicate threads to produce for each initial structure</span>
    <span class="n">init_nodes</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of nodes on which to run initialization jobs</span>
    <span class="n">init_ppn</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of processors per node on which to run initialization jobs</span>
    <span class="n">init_walltime</span> <span class="o">=</span> <span class="s1">&#39;01:00:00&#39;</span>  <span class="c1"># Wall time for initialization jobs</span>
    <span class="n">init_mem</span> <span class="o">=</span> <span class="s1">&#39;4000mb&#39;</span>  <span class="c1"># Memory per core for intialization jobs</span>
    <span class="n">prod_nodes</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of nodes on which to run production jobs</span>
    <span class="n">prod_ppn</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of processors per node on which to run production jobs</span>
    <span class="n">prod_walltime</span> <span class="o">=</span> <span class="s1">&#39;01:00:00&#39;</span>  <span class="c1"># Wall time for production jobs</span>
    <span class="n">prod_mem</span> <span class="o">=</span> <span class="s1">&#39;4000mb&#39;</span>  <span class="c1"># Memory per core for production jobs</span>
    <span class="n">resample</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># If True, don&#39;t run any new simulations; just rewrite as.out based on current settings and existing data</span>
    <span class="n">fork</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of new threads to spawn after each successful shooting move. Each one gets its own call to pickframe()</span>
    <span class="n">home_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Directory containing templates and input_files folders</span>
    <span class="n">always_new</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Pick a new shooting move after every move, even if it isn&#39;t accepted?</span>
    <span class="n">rc_definition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Defines the equation of the reaction coordinate for an rc_eval run</span>
    <span class="n">rc_minmax</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Aimless shooting output file from which to determine minimum and maximum CV values during rc_eval</span>
    <span class="n">as_out</span> <span class="o">=</span> <span class="s1">&#39;as.out&#39;</span>  <span class="c1"># Output filename to identify minimum and maximum values of CVs from (replaces rc_minmax)</span>
    <span class="n">candidateops</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Defines the candidate order parameters to output into the as.out file</span>
    <span class="n">literal_ops</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Determines whether to interpret candidateops as literal python code separated by semi-colons. This isn&#39;t a user-defined option, it&#39;s handled automatically based on the format of candidateops</span>
    <span class="n">commit_define_fwd</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Defines commitment to fwd basin</span>
    <span class="n">commit_define_bwd</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Defines commitment to bwd basin</span>
    <span class="n">committor_analysis</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Variables to pass into committor analysis.</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Whether or not to restart an old AS run located in working_directory</span>
    <span class="n">groupfile</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of jobs to submit in one groupfile, if necessary</span>
    <span class="n">groupfile_max_delay</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># Time in seconds to allow groupfiles to remain in construction before submitting</span>
    <span class="n">include_qdot</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Flag to include order parameter rate of change values in output</span>
    <span class="n">eps_settings</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Equilibrium Path Sampling: [n_windows, k_beads, rc_min, rc_max, traj_length, overlap]</span>
    <span class="n">eps_dynamic_seed</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Flag to seed empty windows using beads from other trajectories during EPS</span>
    <span class="n">minmax_error_behavior</span> <span class="o">=</span> <span class="s1">&#39;accept&#39;</span>  <span class="c1"># Indicates behavior when an reduced OP value is outside range [0,1]</span>
    <span class="n">zip_for_transfer</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Indicates that we should simply zip up necessary files and quit</span>
    <span class="n">cv_analysis</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Indicates that we just want to produce a CV analysis output folder</span>
    <span class="n">skip_log</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Indicates that the user knows the log file is missing or broken and can&#39;t be used for analysis scripts</span>
    <span class="n">bootstrap_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>   <span class="c1"># Threshold for comparison of model RC coefficients during RC bootstrapping</span>
    <span class="n">bootstrap_n</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Number of bootstrapped models to build during RC bootstrapping</span>
    <span class="n">cvs_in_rc</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c1"># Number of CVs to include in RCs produced in the course of sampling</span>
    <span class="n">find_ts</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Indicates that the supplied coordinates are not TS guesses but either reactant or product structures, and need to be made into guesses</span>
    <span class="n">cleanup</span> <span class="o">=</span> <span class="kc">True</span>     <span class="c1"># If True, trajectory files are deleted when no longer needed; not totally implemented for groupfile &gt; 0 # todo: test</span>
    <span class="c1"># todo: add option for solver other than sander.MPI (edit templates to accomodate arbitrary solver name including .MPI if desired)</span>
    <span class="c1"># todo: (ambitious?) add support for arbitrary MD engine? I&#39;m unsure whether I think this task is trivial or monumental</span>

    <span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;as.log&#39;</span>  <span class="c1"># Name of log file. Not user-set at present.</span>
    <span class="n">DEBUGMODE</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># Used only for testing, causing batch system-facing functions to return spoofed output</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span>
            <span class="n">working_directory</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># handles inconsistency in format when the default value is used vs. when a value is given</span>
        <span class="n">working_directory</span> <span class="o">=</span> <span class="n">working_directory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>  <span class="c1"># Function to convert string &quot;True&quot; or &quot;False&quot; to corresponding boolean</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>  <span class="c1"># returns False for anything other than &quot;True&quot; (case-insensitive)</span>

    <span class="c1"># Read in variables from the input file; there&#39;s probably a cleaner way to do this, but no matter.</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">input_file_lines</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">null</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: option &#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; was supplied without a corresponding value&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;initial_structure&#39;</span><span class="p">:</span>
            <span class="n">initial_structure</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;if_glob&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: if_glob must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">if_glob</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;topology&#39;</span><span class="p">:</span>
            <span class="n">topology</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;n_adjust&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: n_adjust must be an integer&#39;</span><span class="p">)</span>
            <span class="n">n_adjust</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;batch_system&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pbs&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: batch_system must be either pbs or slurm&#39;</span><span class="p">)</span>
            <span class="n">batch_system</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># interpreting as a subfolder of cwd</span>
                <span class="n">working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># interpreting as an absolute path</span>
                <span class="n">working_directory</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;commit_fwd&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: commit_define_fwd cannot contain whitespace (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">) characters&#39;</span><span class="p">)</span>
            <span class="n">commit_define_fwd</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># converts a string looking like a list, to an actual list</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">commit_define_fwd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: commit_fwd must have four rows&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;commit_bwd&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: commit_define_bwd cannot contain whitespace (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">) characters&#39;</span><span class="p">)</span>
            <span class="n">commit_define_bwd</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">commit_define_bwd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: commit_bwd must have four rows&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;candidate_cv&#39;</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;candidate_op&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
                <span class="n">literal_ops</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># not a nested list, implies that this is an explicit definition</span>
                <span class="n">full_entry</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># string to write all the input into</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)):</span>  <span class="c1"># full input is contained in entry[index] for all index &gt;= 2</span>
                    <span class="n">full_entry</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>  <span class="c1"># reconstruct the original full string with spaces included</span>
                <span class="n">full_entry</span> <span class="o">=</span> <span class="n">full_entry</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove trailing &#39; &#39;</span>
                <span class="n">candidateops</span> <span class="o">=</span> <span class="n">full_entry</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>  <span class="c1"># each entry should be a string interpretable as an OP</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">literal_ops</span><span class="p">:</span>  <span class="c1"># only do this stuff if the OPs are not given literally</span>
                <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: candidate_cv cannot contain whitespace (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">) characters&#39;</span><span class="p">)</span>
                <span class="n">candidateops</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidateops</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: candidate_cv must have length &gt;= 2&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidateops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: if defining candidate_cv implicitly, exactly two inputs in a list are required&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                        <span class="s1">&#39;Error: if defining candidate_cv implicitly, the first entry must be a string (including quotes)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                        <span class="s1">&#39;Error: if defining candidate_cv implicitly, the second entry must be a string (including quotes)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;restart_on_crash&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: restart_on_crash must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">restart_on_crash</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max_fails&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">max_fails</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: max_fails must be an integer&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max_moves&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">max_moves</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: max_moves must be an integer&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;max_accept&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">max_accept</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: max_accept must be an integer&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;degeneracy&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: degeneracy must be greater than or equal to 1&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: degeneracy must be an integer&#39;</span><span class="p">)</span>
            <span class="n">degeneracy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;init_nodes&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: init_nodes must be greater than or equal to 1&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: init_nodes must be an integer&#39;</span><span class="p">)</span>
            <span class="n">init_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;init_ppn&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: init_ppn must be greater than or equal to 1&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: init_ppn must be an integer&#39;</span><span class="p">)</span>
            <span class="n">init_ppn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;init_walltime&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: init_walltime must have format: HH:MM:SS&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: init_walltime must consist only of colon-separated integers&#39;</span><span class="p">)</span>
            <span class="n">init_walltime</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;prod_nodes&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: prod_nodes must be greater than or equal to 1&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: prod_nodes must be an integer&#39;</span><span class="p">)</span>
            <span class="n">prod_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;prod_ppn&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: prod_ppn must be greater than or equal to 1&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: prod_ppn must be an integer&#39;</span><span class="p">)</span>
            <span class="n">prod_ppn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;prod_walltime&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: prod_walltime must have format: HH:MM:SS&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: prod_walltime must consist only of colon-separated integers&#39;</span><span class="p">)</span>
            <span class="n">prod_walltime</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;resample&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: resample must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">resample</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fork&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: fork must be greater than or equal to 1&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: fork must be an integer&#39;</span><span class="p">)</span>
            <span class="n">fork</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;home_directory&#39;</span><span class="p">:</span>
            <span class="n">home_folder</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;always_new&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: always_new must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">always_new</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rc_definition&#39;</span><span class="p">:</span>
            <span class="n">rc_definition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">rc_definition</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="n">rc_definition</span> <span class="o">=</span> <span class="n">rc_definition</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove trailing space</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rc_minmax&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: rc_minmax cannot contain whitespace (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">) characters&#39;</span><span class="p">)</span>
            <span class="n">rc_minmax</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">rc_minmax</span><span class="p">:</span>  <span class="c1"># to allow rc_minmax = &#39;&#39;, only perform these checks if it&#39;s not</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">rc_minmax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: rc_minmax must have two rows&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rc_minmax</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">rc_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rc_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rc_minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rc_minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                            <span class="s1">&#39;Error: values in the second row of rc_minmax must be larger than the corresponding values in the first row&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;committor_analysis&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: committor_analysis cannot contain whitespace (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">) characters&#39;</span><span class="p">)</span>
            <span class="n">committor_analysis</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">committor_analysis</span><span class="p">:</span>  <span class="c1"># to allow committor_analysis = [], only perform these checks if it&#39;s not</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: committor_analysis must be of length five or six (yours is of length &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">committor_analysis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># if it&#39;s not supplied, use an empty string for committor_suffix</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: committor_analysis[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] must have type float or int, but has type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: committor_analysis[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] must have type int, but has type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                            <span class="s1">&#39;Error: committor_analysis[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] must have type string, but has type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">committor_analysis</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;eps_settings&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: eps_settings cannot contain whitespace (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">) characters&#39;</span><span class="p">)</span>
            <span class="n">eps_settings</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">eps_settings</span><span class="p">:</span>  <span class="c1"># to allow eps_settings = [], only perform these checks if it&#39;s not</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                        <span class="s1">&#39;Error: eps_settings must be of length six (yours is of length &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                            <span class="s1">&#39;Error: eps_settings[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] must have type float or int, but has type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: eps_settings[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;] must have type int, but has type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">eps_settings</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;restart&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: restart must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">restart</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;groupfile&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: groupfile must be greater than or equal to 0&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: groupfile must be an integer&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: groupfile was given as a float (&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;), but should be an integer. &#39;</span>
                                                                               <span class="s1">&#39;Rounding down to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39; and proceeding.&#39;</span><span class="p">)</span>
            <span class="n">groupfile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">groupfile_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># initialize list of groupfiles</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;groupfile_max_delay&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: groupfile_max_delay must be greater than or equal to 0&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: groupfile_max_delay must be an integer&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: groupfile_max_delay was given as a float (&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;), but should be an integer. &#39;</span>
                                                                                         <span class="s1">&#39;Rounding down to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39; and proceeding.&#39;</span><span class="p">)</span>
            <span class="n">groupfile_max_delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;include_qdot&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: include_qdot must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">include_qdot</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;eps_dynamic_seed&#39;</span><span class="p">:</span>
            <span class="n">eps_dynamic_seed</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">eps_dynamic_seed</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: eps_dynamic_seed must be either an integer or a list (yours is of type &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
            <span class="n">empty_windows</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># initialize empty windows list to support dynamic seeding</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;minmax_error_behavior&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;skip&#39;</span><span class="p">,</span> <span class="s1">&#39;accept&#39;</span><span class="p">]:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                    <span class="s1">&#39;Error: minmax_error_behavior must be either exit, skip, or accept (you gave &#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
            <span class="n">minmax_error_behavior</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;zip_for_transfer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: zip_for_transfer must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">zip_for_transfer</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cv_analysis&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: cv_analysis must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">cv_analysis</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;skip_log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: skip_log must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">skip_log</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bootstrap_n&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: bootstrap_n must be an integer&#39;</span><span class="p">)</span>
            <span class="n">bootstrap_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">bootstrap_flag</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># indicates whether bootstrapping has converged</span>
            <span class="n">bootstrap_bookkeep</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># bookkeeping for handle_bootstrap()</span>
            <span class="n">bootstrap_jobids</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># used to track bootstrapping jobs</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bootstrap_threshold&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: bootstrap_threshold must be a float&#39;</span><span class="p">)</span>
            <span class="n">bootstrap_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;find_ts&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: find_ts must be greater than or equal to 0&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: find_ts must be an integer&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: find_ts was given as a float (&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;), but should be an integer. &#39;</span>
                      <span class="s1">&#39;Rounding down to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39; and proceeding.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: find_ts was given as a bool (&#39;</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;), but should be an integer. &#39;</span>
                      <span class="s1">&#39;Interpreting as &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39; and proceeding.&#39;</span><span class="p">)</span>
            <span class="n">find_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;as_out&#39;</span><span class="p">:</span>
            <span class="n">as_out</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cleanup&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: cleanup must be either True or False&#39;</span><span class="p">)</span>
            <span class="n">cleanup</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Remove trailing &#39;/&#39; from working_directory and home_folder for compatibility with my code</span>
    <span class="k">if</span> <span class="n">working_directory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">working_directory</span> <span class="o">=</span> <span class="n">working_directory</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">home_folder</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">home_folder</span> <span class="o">=</span> <span class="n">home_folder</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rc_minmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">as_out</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">as_out</span><span class="p">):</span>
                <span class="n">as_out</span> <span class="o">=</span> <span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">as_out</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">as_out</span><span class="p">):</span>
                <span class="n">as_out</span> <span class="o">=</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">as_out</span>
            <span class="k">elif</span> <span class="n">committor_analysis</span> <span class="ow">or</span> <span class="n">eps_settings</span> <span class="ow">or</span> <span class="n">rc_definition</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: rc_definition, committor_analysis and/or eps_settings options were given, but &#39;</span>
                         <span class="s1">&#39;rc_minmax was not and as_out file: &#39;</span> <span class="o">+</span> <span class="n">as_out</span> <span class="o">+</span> <span class="s1">&#39; was not found when interpreted as an &#39;</span>
                         <span class="s1">&#39;absolute path, in the working directory &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;, or in the home folder &#39;</span>
                         <span class="o">+</span> <span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;. Provide a valid entry for either as_out or rc_minmax.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">committor_analysis</span> <span class="ow">or</span> <span class="n">eps_settings</span> <span class="ow">or</span> <span class="n">rc_definition</span><span class="p">:</span>  <span class="c1"># in this case, we need to build rc_minmax from as_out</span>
            <span class="n">rc_minmax</span> <span class="o">=</span> <span class="p">[[],[]]</span>
            <span class="n">asoutlines</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;A &lt;- &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;B &lt;- &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">as_out</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">as_out</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">asoutlines</span><span class="p">)))</span>
            <span class="n">rc_minmax</span> <span class="o">=</span> <span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">],</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">]]</span>

    <span class="c1"># Initialize jinja2 environment for filling out templates</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;templates&#39;</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
            <span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;templates&#39;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not locate templates folder: &#39;</span> <span class="o">+</span> <span class="n">home_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;templates</span><span class="se">\n</span><span class="s1">See documentation for &#39;</span>
                                                                                    <span class="s1">&#39;the </span><span class="se">\&#39;</span><span class="s1">home_folder</span><span class="se">\&#39;</span><span class="s1"> option.&#39;</span><span class="p">)</span>

    <span class="c1"># Update global settings Namespace object to store all these variables</span>
    <span class="n">settings</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="c1"># Call rc_eval if we&#39;re doing an rc_definition or committor_analysis run</span>
    <span class="k">if</span> <span class="n">rc_definition</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">committor_analysis</span> <span class="ow">or</span> <span class="n">eps_settings</span><span class="p">):</span>
        <span class="n">rc_eval</span><span class="o">.</span><span class="n">return_rcs</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Completed reaction coordinate evaluation run. See &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/rc_eval.out for results.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rc_definition</span> <span class="ow">and</span> <span class="n">committor_analysis</span><span class="p">:</span>
        <span class="n">rc_eval</span><span class="o">.</span><span class="n">committor_analysis</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Completed committor analysis run. See &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/committor_analysis&#39;</span> <span class="o">+</span> <span class="n">committor_analysis</span><span class="p">[</span>
                <span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/committor_analysis.out for results.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">rc_definition</span> <span class="ow">and</span> <span class="n">committor_analysis</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: committor analysis run requires rc_definition to be defined&#39;</span><span class="p">)</span>

    <span class="c1"># Make the working directory if it doesn&#39;t already exist and should be made</span>
    <span class="n">dirName</span> <span class="o">=</span> <span class="n">working_directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resample</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restart</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zip_for_transfer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cv_analysis</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>  <span class="c1"># if (resample or restart or zip_for_transfer or cv_analysis) == True, we want to keep our old working directory</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirName</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>  <span class="c1"># delete old working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>  <span class="c1"># make a new one</span>
    <span class="k">elif</span> <span class="n">resample</span> <span class="ow">or</span> <span class="n">restart</span> <span class="ow">or</span> <span class="n">zip_for_transfer</span> <span class="ow">or</span> <span class="n">cv_analysis</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirName</span><span class="p">):</span>
            <span class="n">whichone</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
                <span class="n">whichone</span> <span class="o">=</span> <span class="s1">&#39;resample&#39;</span>
            <span class="k">elif</span> <span class="n">restart</span><span class="p">:</span>
                <span class="n">whichone</span> <span class="o">=</span> <span class="s1">&#39;restart&#39;</span>
            <span class="k">elif</span> <span class="n">zip_for_transfer</span><span class="p">:</span>
                <span class="n">whichone</span> <span class="o">=</span> <span class="s1">&#39;zip_for_transfer&#39;</span>
            <span class="k">elif</span> <span class="n">cv_analysis</span><span class="p">:</span>
                <span class="n">whichone</span> <span class="o">=</span> <span class="s1">&#39;cv_analysis&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">whichone</span> <span class="o">+</span> <span class="s1">&#39; = True, but I can</span><span class="se">\&#39;</span><span class="s1">t find the working directory: &#39;</span> <span class="o">+</span> <span class="n">dirName</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>  <span class="c1"># if (resample or restart or zip_for_transfer or cv_analysis) == False and overwrite == False, make sure dirName doesn&#39;t exist...</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirName</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: overwrite = False, but working directory &#39;</span> <span class="o">+</span> <span class="n">dirName</span> <span class="o">+</span> <span class="s1">&#39; already exists. Move it, choose a&#39;</span>
                     <span class="s1">&#39; different working directory, or add option -O to overwrite it.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">resample</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restart</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">zip_for_transfer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cv_analysis</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">find_ts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">if_glob</span><span class="p">:</span>
            <span class="n">start_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">initial_structure</span><span class="p">)</span>  <span class="c1"># list of names of coordinate files to begin shooting from</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_structure</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">start_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: one or more input coordinate filenames contains a space character (</span><span class="se">\&#39;</span><span class="s1"> </span><span class="se">\&#39;</span><span class="s1">), which is &#39;</span>
                         <span class="s1">&#39;not supported. The first offending filename found was: &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;bootstrap&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the string </span><span class="se">\&#39;</span><span class="s1">bootstrap</span><span class="se">\&#39;</span><span class="s1"> is reserved for internal use and cannot be included in part &#39;</span>
                         <span class="s1">&#39;of any input coordinate filename. The first offending filename found was: &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: no initial structure found. Check input options initial_structure and if_glob.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="n">start_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">init</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not find initial structure file: &#39;</span> <span class="o">+</span> <span class="n">init</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">degeneracy</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># initialize temporary list to substitute for start_name later</span>
            <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="n">start_name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degeneracy</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">init</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">start_name</span> <span class="o">=</span> <span class="n">temp</span>
    <span class="k">elif</span> <span class="n">find_ts</span><span class="p">:</span>   <span class="c1"># in this case, want to build start_name using the init_find_ts() function.</span>
        <span class="c1"># First, make sure there are no mutually exclusive options provided...</span>
        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and resample = True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc_definition</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and rc_definition is defined&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eps_settings</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and eps_settings is defined&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">committor_analysis</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and committor_analysis is defined&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zip_for_transfer</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and zip_for_transfer = True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cv_analysis</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and cv_analysis = True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and restart = True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">degeneracy</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: find_ts &gt; 0 and degeneracy &gt; 1&#39;</span><span class="p">)</span>
        <span class="c1"># Then grab the input structure and throw an error if there&#39;s more than one</span>
        <span class="k">if</span> <span class="n">if_glob</span><span class="p">:</span>
            <span class="n">start_name</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">initial_structure</span><span class="p">)</span>  <span class="c1"># list of names of coordinate files to begin shooting from</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_structure</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: only one initial structure is permitted when find_ts &gt; 0. The combination of your &#39;</span>
                     <span class="s1">&#39;initial_structure and if_glob settings matches &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_name</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; coordinate files. &#39;</span>
                     <span class="s1">&#39;If you want to build transition state guesses from multiple initial coordinate files, please &#39;</span>
                     <span class="s1">&#39;perform a separate ATESA run for each one.&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>                                 <span class="c1"># move to working directory</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>     <span class="c1"># delete previous run&#39;s log (find_ts is always a new ATESA job)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>                     <span class="c1"># catches error if no previous log file exists</span>
            <span class="k">pass</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newlog</span><span class="p">:</span>
            <span class="n">localtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_min</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mins</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">mins</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">secs</span>
            <span class="n">newlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;~~~New log file &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">secs</span> <span class="o">+</span> <span class="s1">&#39;~~~&#39;</span><span class="p">)</span>
            <span class="n">newlog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">start_name</span><span class="p">:</span>                                <span class="c1"># for all of the initial structures (should be one)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="p">,</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span>        <span class="c1"># copy to the working directory...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">topology</span><span class="p">,</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span>     <span class="c1"># ... and its little topology file, too!</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not find the indicated topology file: &#39;</span> <span class="o">+</span> <span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">topology</span><span class="p">)</span>
        <span class="n">start_name</span> <span class="o">=</span> <span class="n">init_find_ts</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span><span class="n">start_name</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>  <span class="c1"># move to working directory</span>

    <span class="c1"># Initialize files needed for an EPS run if that&#39;s what we&#39;re doing.</span>
    <span class="c1"># Have to do this before potentially calling main_loop() for a restart run if we want that to work.</span>
    <span class="k">if</span> <span class="n">eps_settings</span><span class="p">:</span>
        <span class="n">initialize_eps</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="c1"># Check for incompatible options and return helpful error message if a conflict is found</span>
    <span class="k">if</span> <span class="n">resample</span> <span class="ow">or</span> <span class="n">committor_analysis</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rc_definition</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">eps_settings</span><span class="p">)</span> <span class="ow">or</span> <span class="n">zip_for_transfer</span> <span class="ow">or</span> <span class="n">cv_analysis</span><span class="p">:</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;[UNDEFINED (developer error, please raise GitHub issue)]&#39;</span>
        <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;resample = True&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">rc_definition</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">eps_settings</span><span class="p">):</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;rc_definition is defined and eps_settings is not&#39;</span>
        <span class="k">elif</span> <span class="n">committor_analysis</span><span class="p">:</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;committor_analysis is defined&#39;</span>
        <span class="k">elif</span> <span class="n">zip_for_transfer</span><span class="p">:</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;zip_for_transfer = True&#39;</span>
        <span class="k">elif</span> <span class="n">cv_analysis</span><span class="p">:</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="s1">&#39;cv_analysis = True&#39;</span>
        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>  <span class="c1"># todo: this is crazy ugly...</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: restart = True and &#39;</span> <span class="o">+</span> <span class="n">problem</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">skip_log</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">eps_settings</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">problem</span> <span class="o">+</span> <span class="s1">&#39; but I cannot open &#39;</span> <span class="o">+</span> <span class="n">logfile</span> <span class="o">+</span> <span class="s1">&#39; in the working directory: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fork</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">eps_settings</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: options </span><span class="se">\&#39;</span><span class="s1">fork\ &gt; 1</span><span class="se">\&#39;</span><span class="s1"> and </span><span class="se">\&#39;</span><span class="s1">eps_settings</span><span class="se">\&#39;</span><span class="s1"> are incompatible&#39;</span><span class="p">)</span>

    <span class="c1"># Run auxiliary functions if appropriate</span>
    <span class="k">if</span> <span class="n">zip_for_transfer</span><span class="p">:</span>
        <span class="c1"># Load in pickle and move directly to zip_for_transfer_func()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;restart.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">restartthreads</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="s1">&#39;Error: zip_for_transfer = True, but I cannot read restart.pkl inside working directory: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span><span class="p">)</span>
        <span class="n">zip_for_transfer_func</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Zipped up files in: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/transfer.zip. Exiting normally.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cv_analysis</span><span class="p">:</span>
        <span class="n">cv_analysis_func</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;CV analysis complete, files in &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/cv_analysis/&#39;</span><span class="p">)</span>

    <span class="c1"># Handle initialization of restart settings if appropriate</span>
    <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
        <span class="c1"># First, carefully load in the necessary information:</span>
        <span class="c1"># try:</span>
        <span class="c1">#     os.chdir(working_directory)</span>
        <span class="c1"># except (IOError, OSError):</span>
        <span class="c1">#     sys.exit(&#39;Error: restart = True, but I cannot find the working directory: &#39; + working_directory)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;restart.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">restartthreads</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="s1">&#39;Error: restart = True, but I cannot read restart.pkl inside working directory: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span><span class="p">)</span>
        <span class="c1"># If we&#39;re restarting an EPS run, we need to ensure that the EPS settings are compatible. Specifically, we need</span>
        <span class="c1"># to ensure that the window boundaries that were previously used still exist in the new ones, and that the</span>
        <span class="c1"># number of beads per thread is the same. We would also like to check that the traj_length is the same ideally,</span>
        <span class="c1"># but this information is not stored in threads.</span>
        <span class="k">if</span> <span class="n">eps_settings</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">]:</span>
                        <span class="n">offending</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">offending</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: attempted to restart this EPS run, but the restart.pkl file contained threads with&#39;</span>
                             <span class="s1">&#39; different reaction coordinate boundaries than those defined by the eps_settings option &#39;</span>
                             <span class="s1">&#39;for this job. The offending cutoff value (including overlap) was: &#39;</span> <span class="o">+</span> <span class="n">offending</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: attempted to restart this EPS run, but the restart.pkl file contained threads with&#39;</span>
                             <span class="s1">&#39; a different number of beads than specified by the eps_settings option for this job. &#39;</span>
                             <span class="s1">&#39;The restart.pkl threads contain &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">eps_fwd</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">eps_bwd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; beads, &#39;</span>
                             <span class="s1">&#39;whereas for this run k_beads was set to: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">k_beads</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">:</span>
                <span class="c1"># Need to handle empty_windows, since unlike in normal behavior threads are beginning (restarting)</span>
                <span class="c1"># without going through spawnthread().</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">eps_dynamic_seed</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span> <span class="o">=</span> <span class="p">[</span><span class="n">eps_dynamic_seed</span> <span class="k">for</span> <span class="n">null</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">eps_dynamic_seed</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: eps_dynamic_seed was given as a list, but is not of the same length as the &#39;</span>
                             <span class="s1">&#39;number of EPS windows. There are &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; EPS windows&#39;</span>
                             <span class="s1">&#39; but eps_dynamic_seed is of length &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">)))</span>
                <span class="n">window_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_dynamic_seed</span><span class="p">[</span><span class="n">window_index</span><span class="p">])</span>  <span class="c1"># meaning eps_dynamic_seed[window_index] more threads need to start here before it will no longer be considered &quot;empty&quot;</span>
                    <span class="n">window_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max_accept&#39;</span><span class="p">,</span> <span class="s1">&#39;max_moves&#39;</span><span class="p">,</span> <span class="s1">&#39;max_fails&#39;</span><span class="p">]:</span>
                        <span class="n">window_index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span><span class="p">))</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window_index</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">empty_windows</span><span class="p">[</span><span class="n">window_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">restartthreads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>  <span class="c1"># so as not to restart more threads than requested</span>

        <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Next, add those threads that haven&#39;t terminated to the itinerary and call main_loop</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">restartthreads</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max_accept&#39;</span><span class="p">,</span> <span class="s1">&#39;max_moves&#39;</span><span class="p">,</span> <span class="s1">&#39;max_fails&#39;</span><span class="p">]:</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">eps_settings</span> <span class="ow">and</span> <span class="n">thread</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;prod&#39;</span><span class="p">:</span>  <span class="c1"># remove old output trajs to prevent crossed wires</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>   <span class="c1"># old file never written; not a problem!</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">commit1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">commit2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">localtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">mins</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">secs</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">~~~Restarting &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">secs</span> <span class="o">+</span> <span class="s1">&#39;~~~&#39;</span><span class="p">)</span>
        <span class="n">main_loop</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>  <span class="c1"># not an error, this is exiting normally</span>

    <span class="k">if</span> <span class="n">eps_settings</span> <span class="ow">and</span> <span class="p">(</span><span class="n">always_new</span> <span class="ow">or</span> <span class="n">bootstrap_n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">always_new</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: eps_settings and always_new&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bootstrap_n</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: the following options are incompatible: eps_settings and bootstrap_n&#39;</span><span class="p">)</span>

    <span class="c1"># Check if candidate_cv is given explicitly or as [mask, coordinates], and if the latter, build the explicit form</span>
    <span class="c1"># NOTE: This code works and remains in place here for posterity; however, actually using it is probably not advised,</span>
    <span class="c1"># as it usually produces far too many OPs to practically test with LMAX.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">literal_ops</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">topology</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: unable to load coordinate file &#39;</span> <span class="o">+</span> <span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; with topology &#39;</span> <span class="o">+</span> <span class="n">topology</span><span class="p">)</span>
        <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">set_reference</span><span class="p">(</span><span class="n">traj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># set reference frame to first frame</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pytraj</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">atom_indices</span><span class="p">:</span>  <span class="c1"># if distance = 0 or if there&#39;s a formatting error</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: found no atoms matching &#39;</span> <span class="o">+</span> <span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; in file &#39;</span> <span class="o">+</span> <span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                     <span class="o">+</span> <span class="s1">&#39;. This may indicate an issue with the format of the candidate_cv option!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if formatted correctly but only matches self</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: mask &#39;</span> <span class="o">+</span> <span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; with file &#39;</span> <span class="o">+</span> <span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; only matches one atom.&#39;</span>
                     <span class="o">+</span> <span class="s1">&#39; Cannot produce any order parameters!&#39;</span><span class="p">)</span>

        <span class="c1"># Super-ugly nested loops to build every combination of indices...</span>
        <span class="n">temp_ops</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]]</span>  <span class="c1"># temporary list to append candidate ops to as they&#39;re built</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">),</span> <span class="s1">&#39;Building all possible order parameters using atoms matching &#39;</span> <span class="o">+</span>
                            <span class="n">candidateops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; with file &#39;</span> <span class="o">+</span> <span class="n">candidateops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">second_index</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">:</span>  <span class="c1"># second-order connections (distances)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">second_index</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                    <span class="n">temp_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                    <span class="n">temp_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_index</span><span class="p">))</span>
                    <span class="n">temp_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">temp_ops</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">third_index</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span> <span class="o">==</span> <span class="n">third_index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">second_index</span> <span class="o">==</span> <span class="n">third_index</span><span class="p">:</span>
                            <span class="n">temp_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                            <span class="n">temp_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_index</span><span class="p">))</span>
                            <span class="n">temp_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">third_index</span><span class="p">))</span>
                            <span class="n">temp_ops</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="c1"># Temporarily commented out to omit dihedrals while we develop LMAX code to handle huge numbers of OPs</span>
                            <span class="c1"># for fourth_index in atom_indices:</span>
                            <span class="c1">#     if not index == fourth_index and not second_index == fourth_index and not third_index == fourth_index:</span>
                            <span class="c1">#         temp_ops[0].append(&#39;@&#39; + str(index))</span>
                            <span class="c1">#         temp_ops[1].append(&#39;@&#39; + str(second_index))</span>
                            <span class="c1">#         temp_ops[2].append(&#39;@&#39; + str(third_index))</span>
                            <span class="c1">#         temp_ops[3].append(&#39;@&#39; + str(fourth_index))</span>

        <span class="c1"># Then go back through and remove redundant OPs...</span>
        <span class="c1"># For some reason this takes much longer than the above block. Reading temp_ops must be much slower than writing?</span>
        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">total_iters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mirrors_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list containing mirrors of OP definitions</span>
        <span class="c1"># If an OP is already in mirrors_list, it&#39;s deleted from temp_ops; if not, its mirror is added to temp_ops</span>
        <span class="k">while</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">total_iters</span><span class="p">,</span> <span class="s1">&#39;Removing redundant coordinates&#39;</span><span class="p">)</span>
            <span class="n">one</span> <span class="o">=</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
            <span class="n">two</span> <span class="o">=</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
            <span class="n">three</span> <span class="o">=</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
            <span class="n">four</span> <span class="o">=</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">four</span> <span class="ow">and</span> <span class="p">[</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">three</span><span class="p">,</span> <span class="n">four</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mirrors_list</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="p">(</span><span class="n">three</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">four</span> <span class="ow">and</span> <span class="p">[</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">three</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mirrors_list</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">three</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">four</span> <span class="ow">and</span> <span class="p">[</span><span class="n">one</span><span class="p">,</span> <span class="n">two</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mirrors_list</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">temp_ops</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
                <span class="n">position</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">four</span><span class="p">:</span>
                <span class="n">mirrors_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">four</span><span class="p">,</span> <span class="n">three</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">one</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">three</span><span class="p">:</span>
                <span class="n">mirrors_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">three</span><span class="p">,</span> <span class="n">two</span><span class="p">,</span> <span class="n">one</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mirrors_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">two</span><span class="p">,</span> <span class="n">one</span><span class="p">])</span>
            <span class="n">position</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span> <span class="o">=</span> <span class="n">temp_ops</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The finalized order parameter definition is: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">candidateops</span><span class="p">))</span>

    <span class="c1"># Return an error and exit if the input file is missing entries for non-optional inputs.</span>
    <span class="k">if</span> <span class="s1">&#39;commit_fwd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">input_file_lines</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">resample</span> <span class="ow">or</span> <span class="n">rc_definition</span> <span class="ow">or</span> <span class="n">eps_settings</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: input file is missing entry for commit_fwd, which is non-optional&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;commit_bwd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">input_file_lines</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">resample</span> <span class="ow">or</span> <span class="n">rc_definition</span> <span class="ow">or</span> <span class="n">eps_settings</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: input file is missing entry for commit_bwd, which is non-optional&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;candidate_cv&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">input_file_lines</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;candidate_op&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">input_file_lines</span><span class="p">]:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: input file is missing entry for candidate_cv, which is non-optional&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">resample</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restart</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># a list of threads that need running</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># a list of currently running threads</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">allthreads</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># a list of all threads regardless of status</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">find_ts</span><span class="p">:</span> <span class="c1"># if find_ts, this has already been done</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>  <span class="c1"># delete previous run&#39;s log</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># catches error if no previous log file exists</span>
                <span class="k">pass</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newlog</span><span class="p">:</span>
                <span class="n">localtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
                <span class="n">mins</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_min</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mins</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">mins</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">secs</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">secs</span>
                <span class="n">newlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;~~~New log file &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">localtime</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">secs</span> <span class="o">+</span> <span class="s1">&#39;~~~&#39;</span><span class="p">)</span>
                <span class="n">newlog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">start_name</span><span class="p">:</span>    <span class="c1"># for all of the initial structures...</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">find_ts</span><span class="p">:</span>             <span class="c1"># if find_ts, structures are already in working directory</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="p">,</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span>  <span class="c1"># copy the input structure to the working directory...</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">topology</span><span class="p">,</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span>  <span class="c1"># ... and its little topology file, too!</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not find the indicated topology file: &#39;</span> <span class="o">+</span> <span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">topology</span><span class="p">)</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">spawnthread</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># spawn a new thread with default settings</span>
            <span class="c1"># thread.last_valid = &#39;0&#39;                                 # so that if the first shooting point does not result in a valid transition path, shooting will begin from the TS guess</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span> <span class="o">=</span> <span class="n">topology</span>  <span class="c1"># set prmtop filename for the thread</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>  <span class="c1"># submit it to the itinerary</span>
            <span class="k">if</span> <span class="n">degeneracy</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if degeneracy &gt; 1, files in start_name were copies...</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">called_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="p">)</span>  <span class="c1"># ... delete them to keep the user&#39;s space clean!</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">)</span>  <span class="c1"># delete previous run&#39;s output file</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># catches error if no previous output file exists</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">eps_settings</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newout</span><span class="p">:</span>  <span class="c1"># make a new output file</span>
            <span class="n">newout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Implementation of resample</span>
    <span class="k">if</span> <span class="n">resample</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">eps_settings</span><span class="p">:</span>  <span class="c1"># if True, this is a resample run, so we&#39;ll head off the simulations steps here</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\ .*\ finished&#39;</span><span class="p">)</span>  <span class="c1"># pattern to find job name</span>
        <span class="n">pattern2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;result:\ [a-z]*\ &#39;</span><span class="p">)</span>  <span class="c1"># pattern for basin commitment flag</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_log</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>  <span class="c1"># open log for reading...</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: could not find &#39;</span> <span class="o">+</span> <span class="n">logfile</span> <span class="o">+</span> <span class="s1">&#39; in working directory: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span><span class="p">)</span>
            <span class="n">logfile_lines</span> <span class="o">=</span> <span class="n">this_logfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">this_logfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">logfile_lines</span><span class="p">:</span>  <span class="c1"># iterate through log file</span>
                <span class="k">if</span> <span class="s1">&#39;finished with fwd trajectory result: &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># looking for lines with results</span>
                    <span class="n">commit</span> <span class="o">=</span> <span class="n">pattern2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># first, identify the commitment flag</span>
                    <span class="k">if</span> <span class="n">commit</span> <span class="o">!=</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>  <span class="c1"># none of this matters if it was &quot;fail&quot;</span>
                        <span class="n">basin</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
                        <span class="k">if</span> <span class="n">commit</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                            <span class="n">basin</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
                        <span class="k">elif</span> <span class="n">commit</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
                            <span class="n">basin</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
                        <span class="n">init_name</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span>  <span class="c1"># clunky; removes &quot;run &quot; and &quot; finished&quot;</span>
                        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">basin</span> <span class="o">+</span> <span class="s1">&#39; &lt;- &#39;</span> <span class="o">+</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">init_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">logfile_lines</span><span class="p">),</span> <span class="s1">&#39;Resampling by searching through logfile&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># we can&#39;t use the log file, so we&#39;ll use the thread.history attributes instead</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># I need allthreads to identify threads with zero accepted moves and skip them</span>
                <span class="n">allthreads</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;restart.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                    <span class="s1">&#39;Error: (resample and skip_log) = True, but I cannot read restart.pkl inside working directory: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span><span class="p">)</span>
            <span class="n">num_moves</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">allthreads</span><span class="p">:</span>
                <span class="n">num_moves</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">num_moves</span><span class="p">,</span> <span class="s1">&#39;Resampling by searching through thread histories&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">allthreads</span><span class="p">:</span>
                <span class="n">before_first_accept</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]:</span>  <span class="c1"># just a brief sanity check</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: thread history for thread: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; is formatted incorrectly&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">before_first_accept</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                            <span class="n">before_first_accept</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">fwd_commit</span> <span class="o">=</span> <span class="n">standalone_checkcommit</span><span class="p">(</span><span class="n">move</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">fwd_commit</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                                <span class="n">fwd_commit</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
                            <span class="k">elif</span> <span class="n">fwd_commit</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
                                <span class="n">fwd_commit</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
                                <span class="c1"># Else, fwd_commit = &#39;fail&#39;</span>
                    <span class="k">elif</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>  <span class="c1"># fwd, commit to &#39;B&#39;</span>
                        <span class="n">fwd_commit</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
                    <span class="k">elif</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>  <span class="c1"># bwd, commit to &#39;A&#39;</span>
                        <span class="n">fwd_commit</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
                    <span class="k">elif</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>  <span class="c1"># have to check, in this case</span>
                        <span class="n">fwd_commit</span> <span class="o">=</span> <span class="n">standalone_checkcommit</span><span class="p">(</span><span class="n">move</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fwd_commit</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                            <span class="n">fwd_commit</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
                        <span class="k">elif</span> <span class="n">fwd_commit</span> <span class="o">==</span> <span class="s1">&#39;bwd&#39;</span><span class="p">:</span>
                            <span class="n">fwd_commit</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
                            <span class="c1"># Else, fwd_commit = &#39;fail&#39;</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">before_first_accept</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fwd_commit</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>
                        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;as.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fwd_commit</span> <span class="o">+</span> <span class="s1">&#39; &lt;- &#39;</span> <span class="o">+</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">move</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span>
                                                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">num_moves</span><span class="p">,</span> <span class="s1">&#39;Resampling by searching through thread histories&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Resampling complete; wrote new output to &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/as.out&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">resample</span> <span class="ow">and</span> <span class="n">eps_settings</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">report_rc_values</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">thread</span><span class="p">):</span>
            <span class="c1"># Simple function for outputting the RC values for a given trajectory traj to the eps_results.out file</span>
            <span class="n">rc_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;.rst&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span> <span class="ow">or</span> <span class="s1">&#39;.rst7&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span><span class="p">:</span>
                <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;.rst7&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;.nc&#39;</span> <span class="ow">in</span> <span class="n">coord_file</span><span class="p">:</span>
                <span class="n">fileformat</span> <span class="o">=</span> <span class="s1">&#39;.nc&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: report_rc_values() encountered a file of unknown format: &#39;</span> <span class="o">+</span> <span class="n">coord_file</span><span class="p">)</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">pytraj</span><span class="o">.</span><span class="n">iterload</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">prmtop</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fileformat</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()):</span>  <span class="c1"># iterate through frames of traj</span>
                <span class="n">cv_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">coord_file</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cv</span><span class="p">]</span>  <span class="c1"># CV values as a list</span>
                <span class="n">rc_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rc_value</span><span class="p">(</span><span class="n">cv_values</span><span class="o">=</span><span class="n">cv_values</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rc_values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span><span class="p">:</span>  <span class="c1"># only write to output if the bead is inside the window</span>
                    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eps_results.out&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">rc_values</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># I need allthreads to identify threads with zero accepted moves and skip them</span>
            <span class="n">allthreads</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;restart.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="s1">&#39;Error: (resample and eps_settings) = True, but I cannot read restart.pkl inside working directory: &#39;</span> <span class="o">+</span> <span class="n">working_directory</span><span class="p">)</span>
        <span class="n">num_moves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">allthreads</span><span class="p">:</span>
            <span class="n">num_moves</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">num_moves</span><span class="p">,</span> <span class="s1">&#39;Resampling by searching through thread histories&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">allthreads</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">move</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]:</span>  <span class="c1"># just a brief sanity check</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: thread history for thread: &#39;</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39; is formatted incorrectly&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">cv_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">candidatevalues</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cv</span><span class="p">]</span>  <span class="c1"># CV values as a list</span>
                    <span class="n">rc_value</span> <span class="o">=</span> <span class="n">get_rc_value</span><span class="p">(</span><span class="n">cv_values</span><span class="o">=</span><span class="n">cv_values</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">window_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window_index</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rc_value</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">rc_min</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span>
                            <span class="n">thread</span><span class="o">.</span><span class="n">rc_max</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">eps_windows</span><span class="p">[</span><span class="n">window_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlap</span>
                            <span class="k">break</span>

                <span class="n">report_rc_values</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_init_fwd.rst&#39;</span><span class="p">,</span> <span class="n">thread</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">):</span>
                    <span class="n">report_rc_values</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_fwd.nc&#39;</span><span class="p">,</span> <span class="n">thread</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">):</span>
                    <span class="n">report_rc_values</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_bwd.nc&#39;</span><span class="p">,</span> <span class="n">thread</span><span class="p">)</span>

                <span class="n">update_progress</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">num_moves</span><span class="p">,</span> <span class="s1">&#39;Resampling by searching through EPS thread histories&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Resampling complete; wrote new output to &#39;</span> <span class="o">+</span> <span class="n">working_directory</span> <span class="o">+</span> <span class="s1">&#39;/eps_results.out&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;history&#39;</span><span class="p">)</span>  <span class="c1"># make a new directory to contain the history files of each thread</span>

    <span class="n">main_loop</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>     <span class="c1"># this call to main_loop only reached if this is a new run (not restarted)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>              <span class="c1"># not an error, this is exiting normally</span></div>


<span class="c1"># Define runtime for when this program is called</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>  <span class="c1"># doesn&#39;t return a status and is not followed by sys.exit() because main() and subfunctions handle that</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Tucker Burgin.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>